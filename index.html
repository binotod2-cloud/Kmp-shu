<script>
// ===== DATA GLOBAL =====
let anggotaList = [];
let transaksiList = [];
const BUNGA_SUKARELA = 0.5;
const STORAGE_KEY = 'kmp_pasirgombong_v17_data';

// ===== LOCAL STORAGE FUNCTIONS =====
function saveToStorage() {
  try {
    const data = {
      anggotaList: anggotaList.map(a => ({ ...a })), // Deep copy
      transaksiList: transaksiList.map(t => ({ ...t }))
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch (error) {
    console.warn('Gagal menyimpan ke localStorage:', error);
  }
}

function loadFromStorage() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (!saved) return false;

    const data = JSON.parse(saved);
    if (data.anggotaList && Array.isArray(data.anggotaList)) {
      anggotaList = data.anggotaList.map(a => ({
        ...a,
        lastInterestDate: a.lastInterestDate || a.tgl,
        shu: a.shu || 0
      }));
    }
    if (data.transaksiList && Array.isArray(data.transaksiList)) {
      transaksiList = data.transaksiList;
    }

    // Update lastInterestDate dari transaksi jika lebih baru
    anggotaList.forEach(anggota => {
      const memberTrans = transaksiList.filter(t => t.id === anggota.id);
      if (memberTrans.length > 0) {
        const latest = memberTrans.reduce((latest, t) => 
          new Date(t.tgl) > new Date(latest) ? t.tgl : latest, anggota.tgl);
        anggota.lastInterestDate = latest;
      }
    });

    return true;
  } catch (error) {
    console.error('Gagal memuat dari localStorage:', error);
    alert('⚠️ Data lokal rusak. Memulai dengan data kosong.');
    return false;
  }
}

// ===== INIT =====
window.addEventListener('DOMContentLoaded', function() {
  try {
    const today = new Date();
    document.getElementById('daftarTanggal').valueAsDate = today;
    document.getElementById('trxTanggal').valueAsDate = today;
    document.getElementById('shuBulan').value = today.toISOString().slice(0, 7);

    // Coba muat dari localStorage
    const loaded = loadFromStorage();
    if (!loaded) {
      anggotaList = [];
      transaksiList = [];
    }

    renderTableAnggota();
    updateSelectAnggota();
    renderTableTransaksi();
    renderTableInfoAnggota();

    if (loaded) {
      console.log('✅ Data berhasil dimuat dari localStorage');
    }
  } catch (error) {
    console.error('Error during initialization:', error);
    alert('❌ Terjadi kesalahan saat inisialisasi. Silakan coba lagi.');
  }
});

// ===== UTILITY (Sama seperti sebelumnya) =====
function showTab(tab) {
  try {
    const tabs = ['anggota', 'transaksi', 'shu'];
    tabs.forEach(t => {
      const element = document.getElementById(`tab-${t}`);
      if (element) {
        element.style.display = t === tab ? 'block' : 'none';
      }
    });
  } catch (error) {
    console.error('Error in showTab:', error);
    alert('❌ Gagal beralih tab.');
  }
}

function shuPeriodeChange() {
  try {
    const per = document.getElementById('shuPeriode').value;
    const input = document.getElementById('shuBulan');
    if (per === 'tahunan') {
      input.type = 'number';
      input.placeholder = 'Tahun (misal: 2025)';
      input.min = 2020;
      input.max = 2030;
      input.value = new Date().getFullYear();
    } else {
      input.type = 'month';
      input.value = new Date().toISOString().slice(0, 7);
    }
  } catch (error) {
    console.error('Error in shuPeriodeChange:', error);
  }
}

function formatRupiah(angka) {
  try {
    return 'Rp ' + Math.round(angka).toLocaleString('id-ID');
  } catch (error) {
    return 'Rp 0';
  }
}

function toggleTable(tableId) {
  try {
    const table = document.getElementById(tableId);
    if (table) table.classList.toggle('hidden');
  } catch (error) {
    console.error('Error in toggleTable:', error);
  }
}

function togglePreview() {
  try {
    const preview = document.getElementById('previewArea');
    if (preview) preview.classList.toggle('hidden');
  } catch (error) {
    console.error('Error in togglePreview:', error);
  }
}

// ===== PANGGIL saveToStorage() SETIAP KALI DATA BERUBAH =====
function triggerSave() {
  saveToStorage();
  renderTableAnggota();
  updateSelectAnggota();
  renderTableTransaksi();
  renderTableInfoAnggota();
}

// ===== IMPORT EXCEL (Sama, tapi tambah save) =====
function importFromExcel() {
  try {
    const fileInput = document.getElementById('importExcel');
    const file = fileInput.files[0];
    if (!file) {
      alert('❌ Pilih file Excel terlebih dahulu!');
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        anggotaList = [];
        transaksiList = [];

        const wsAnggota = workbook.Sheets['Data Anggota'];
        if (wsAnggota) {
          const jsonAnggota = XLSX.utils.sheet_to_json(wsAnggota, { defval: '' });
          jsonAnggota.forEach(row => {
            try {
              if (row.Tanggal && row.ID && row.Nama && 
                  row['Simpanan Pokok'] >= 0 && row['Simpanan Wajib'] >= 0 && 
                  row['Simpanan Sukarela'] >= 0) {
                anggotaList.push({
                  tgl: row.Tanggal,
                  id: row.ID,
                  nama: row.Nama,
                  pokok: parseFloat(row['Simpanan Pokok']) || 0,
                  wajib: parseFloat(row['Simpanan Wajib']) || 0,
                  sukarela: parseFloat(row['Simpanan Sukarela']) || 0,
                  totalDana: (parseFloat(row['Simpanan Pokok']) || 0) + 
                            (parseFloat(row['Simpanan Wajib']) || 0) + 
                            (parseFloat(row['Simpanan Sukarela']) || 0),
                  lastInterestDate: row.Tanggal,
                  shu: 0
                });
              }
            } catch (rowError) {
              console.warn('Skip row:', row, rowError);
            }
          });
        }

        const wsTransaksi = workbook.Sheets['Riwayat Transaksi'];
        if (wsTransaksi) {
          const jsonTransaksi = XLSX.utils.sheet_to_json(wsTransaksi, { defval: '' });
          jsonTransaksi.forEach(row => {
            try {
              if (row.Tanggal && row.ID && row.Nama) {
                transaksiList.push({
                  tgl: row.Tanggal,
                  id: row.ID,
                  nama: row.Nama,
                  tambahWajib: parseFloat(row['Tambah Wajib']) || 0,
                  tambahSukarela: parseFloat(row['Tambah Sukarela']) || 0,
                  bunga: parseFloat(row['Bunga Sukarela']) || 0,
                  sukarelaSetelah: parseFloat(row['Sukarela Setelah']) || 0,
                  belanja: parseFloat(row.Belanja) || 0,
                  keterangan: row.Keterangan || ''
                });
              }
            } catch (rowError) {
              console.warn('Skip transaksi:', row, rowError);
            }
          });
        }

        anggotaList.forEach(anggota => {
          const memberTrans = transaksiList.filter(t => t.id === anggota.id);
          if (memberTrans.length > 0) {
            anggota.lastInterestDate = memberTrans.reduce((latest, t) => 
              new Date(t.tgl) > new Date(latest) ? t.tgl : latest, anggota.tgl);
          }
        });

        triggerSave(); // Simpan setelah import
        alert('✅ Data berhasil diimpor dari Excel!');
        fileInput.value = '';
      } catch (error) {
        console.error('Error import:', error);
        alert('❌ Gagal mengimpor. Pastikan format Excel benar.');
      }
    };
    reader.readAsArrayBuffer(file);
  } catch (error) {
    console.error('Error in importFromExcel:', error);
  }
}

// ===== ANGGOTA (panggil triggerSave) =====
function tambahAnggota() {
  try {
    const tgl = document.getElementById('daftarTanggal').value;
    let id = document.getElementById('daftarId').value.trim();
    const nama = document.getElementById('daftarNama').value.trim();
    const pokok = parseFloat(document.getElementById('daftarPokok').value) || 0;
    const wajib = parseFloat(document.getElementById('daftarWajib').value) || 0;
    const sukarela = parseFloat(document.getElementById('daftarSukarela').value) || 0;

    if (!tgl || !nama || pokok <= 0 || wajib <= 0) {
      alert('❌ Data tidak lengkap atau tidak valid!');
      return;
    }

    if (!id) id = 'A' + String(anggotaList.length + 1).padStart(3, '0');
    if (anggotaList.find(a => a.id === id)) {
      alert('❌ ID sudah digunakan!');
      return;
    }

    const anggota = { tgl, id, nama, pokok, wajib, sukarela, 
      totalDana: pokok + wajib + sukarela, lastInterestDate: tgl, shu: 0 };
    anggotaList.push(anggota);
    tambahTransaksiAwal(anggota);

    triggerSave();
    document.getElementById('daftarId').value = '';
    document.getElementById('daftarNama').value = '';
    alert('✅ Anggota berhasil ditambahkan!');
  } catch (error) {
    console.error('Error tambahAnggota:', error);
  }
}

function saveEdit(idx) {
  try {
    const anggota = anggotaList[idx];
    const tgl = document.getElementById(`edit-tgl-${idx}`)?.value || anggota.tgl;
    const nama = document.getElementById(`edit-nama-${idx}`)?.value?.trim() || anggota.nama;
    const pokok = parseFloat(document.getElementById(`edit-pokok-${idx}`)?.value) || anggota.pokok;
    const wajib = parseFloat(document.getElementById(`edit-wajib-${idx}`)?.value) || anggota.wajib;
    const sukarela = parseFloat(document.getElementById(`edit-sukarela-${idx}`)?.value) || anggota.sukarela;
    const shu = parseFloat(document.getElementById(`edit-shu-${idx}`)?.value) || anggota.shu;

    if (!nama || pokok <= 0 || wajib <= 0) {
      alert('❌ Nama/Pokok/Wajib tidak valid!');
      return;
    }

    anggota.tgl = tgl;
    anggota.nama = nama;
    anggota.pokok = pokok;
    anggota.wajib = wajib;
    anggota.sukarela = sukarela;
    anggota.shu = shu;
    anggota.totalDana = pokok + wajib + sukarela;
    anggota.lastInterestDate = tgl;

    const initialTrx = transaksiList.find(t => t.id === anggota.id && t.keterangan === 'Pendaftaran Awal');
    if (initialTrx) {
      initialTrx.tgl = tgl;
      initialTrx.nama = nama;
      initialTrx.tambahWajib = wajib;
      initialTrx.tambahSukarela = sukarela;
      initialTrx.sukarelaSetelah = sukarela;
    }

    triggerSave();
    alert('✅ Data berhasil diperbarui!');
  } catch (error) {
    console.error('Error saveEdit:', error);
  }
}

function hapusAnggota(idx) {
  try {
    if (confirm('Yakin hapus anggota ' + anggotaList[idx].nama + '?')) {
      const id = anggotaList[idx].id;
      anggotaList.splice(idx, 1);
      transaksiList = transaksiList.filter(t => t.id !== id);
      triggerSave();
    }
  } catch (error) {
    console.error('Error hapusAnggota:', error);
  }
}

// ===== TRANSAKSI (panggil triggerSave) =====
function prosesTransaksi() {
  try {
    const idx = document.getElementById('selAnggota').value;
    const tgl = document.getElementById('trxTanggal').value;
    const tambahWajib = parseFloat(document.getElementById('inputTambahWajib').value) || 0;
    const tambahSukarela = parseFloat(document.getElementById('inputTambahSukarela').value) || 0;
    const belanja = parseFloat(document.getElementById('inputBelanja').value) || 0;

    if (idx === '' || !tgl || (tambahWajib === 0 && tambahSukarela === 0 && belanja === 0)) {
      alert('❌ Data tidak lengkap!');
      return;
    }

    const anggota = anggotaList[idx];
    let bunga = 0;
    if (anggota.sukarela > 0) {
      bunga = anggota.sukarela * (BUNGA_SUKARELA / 100);
      anggota.sukarela += bunga;
    }

    anggota.wajib += tambahWajib;
    anggota.sukarela += tambahSukarela;
    anggota.totalDana = anggota.pokok + anggota.wajib + anggota.sukarela;
    anggota.lastInterestDate = tgl;

    transaksiList.push({
      tgl, id: anggota.id, nama: anggota.nama,
      tambahWajib, tambahSukarela, bunga,
      sukarelaSetelah: anggota.sukarela, belanja,
      keterangan: 'Transaksi'
    });

    triggerSave();
    updatePreviewAnggota();
    document.getElementById('inputTambahWajib').value = 0;
    document.getElementById('inputTambahSukarela').value = 0;
    document.getElementById('inputBelanja').value = 0;
    alert('✅ Transaksi berhasil!');
  } catch (error) {
    console.error('Error prosesTransaksi:', error);
  }
}

function applyInterestOneMonth() {
  try {
    const tgl = document.getElementById('trxTanggal').value;
    if (!tgl || anggotaList.length === 0) {
      alert('❌ Data tidak lengkap!');
      return;
    }

    let count = 0;
    anggotaList.forEach(anggota => {
      if (anggota.sukarela > 0) {
        const bunga = anggota.sukarela * (BUNGA_SUKARELA / 100);
        anggota.sukarela += bunga;
        anggota.totalDana = anggota.pokok + anggota.wajib + anggota.sukarela;
        anggota.lastInterestDate = tgl;
        transaksiList.push({
          tgl, id: anggota.id, nama: anggota.nama,
          tambahWajib: 0, tambahSukarela: 0, bunga,
          sukarelaSetelah: anggota.sukarela, belanja: 0,
          keterangan: 'Bunga Bulanan'
        });
        count++;
      }
    });

    triggerSave();
    alert(`✅ Bunga 1 bulan dihitung untuk ${count} anggota!`);
  } catch (error) {
    console.error('Error applyInterestOneMonth:', error);
  }
}

function applyInterestCustomMonths() {
  try {
    const tgl = document.getElementById('trxTanggal').value;
    const numMonths = parseInt(document.getElementById('customBulan').value) || 1;
    if (!tgl || anggotaList.length === 0 || numMonths < 1) {
      alert('❌ Data tidak valid!');
      return;
    }

    const calcDate = new Date(tgl);
    let count = 0;
    anggotaList.forEach(anggota => {
      let currentSukarela = anggota.sukarela;
      for (let i = 0; i < numMonths; i++) {
        const monthDate = new Date(calcDate);
        monthDate.setMonth(calcDate.getMonth() - i);
        const dateStr = monthDate.toISOString().slice(0, 10);
        if (currentSukarela > 0) {
          const bunga = currentSukarela * (BUNGA_SUKARELA / 100);
          currentSukarela += bunga;
          transaksiList.push({
            tgl: dateStr, id: anggota.id, nama: anggota.nama,
            tambahWajib: 0, tambahSukarela: 0, bunga,
            sukarelaSetelah: currentSukarela, belanja: 0,
            keterangan: `Bunga Bulan ${monthDate.toLocaleString('id-ID', { month: 'long', year: 'numeric' })}`
          });
        }
      }
      if (currentSukarela > anggota.sukarela) {
        anggota.sukarela = currentSukarela;
        anggota.totalDana = anggota.pokok + anggota.wajib + anggota.sukarela;
        anggota.lastInterestDate = tgl;
        count++;
      }
    });

    triggerSave();
    alert(`✅ Bunga ${numMonths} bulan dihitung untuk ${count} anggota!`);
  } catch (error) {
    console.error('Error applyInterestCustomMonths:', error);
  }
}

function saveInfoAnggota(idx) {
  try {
    const anggota = anggotaList[idx];
    const tgl = document.getElementById('trxTanggal').value;
    const tambahWajib = parseFloat(document.getElementById(`info-tambahWajib-${idx}`).value) || 0;
    const tambahSukarela = parseFloat(document.getElementById(`info-tambahSukarela-${idx}`).value) || 0;
    const belanja = parseFloat(document.getElementById(`info-belanja-${idx}`).value) || 0;

    if (!tgl || (tambahWajib === 0 && tambahSukarela === 0 && belanja === 0)) {
      alert('❌ Data tidak lengkap!');
      return;
    }

    anggota.wajib += tambahWajib;
    anggota.sukarela += tambahSukarela;
    anggota.totalDana = anggota.pokok + anggota.wajib + anggota.sukarela;
    anggota.lastInterestDate = tgl;

    transaksiList.push({
      tgl, id: anggota.id, nama: anggota.nama,
      tambahWajib, tambahSukarela, bunga: 0,
      sukarelaSetelah: anggota.sukarela, belanja,
      keterangan: 'Transaksi dari Info Anggota'
    });

    triggerSave();
    alert('✅ Transaksi disimpan!');
  } catch (error) {
    console.error('Error saveInfoAnggota:', error);
  }
}

function deleteInfoAnggota(idx) {
  try {
    const anggota = anggotaList[idx];
    if (!confirm(`Hapus transaksi terbaru ${anggota.nama}?`)) return;

    const latestIndex = transaksiList.slice().reverse().findIndex(t => t.id === anggota.id);
    if (latestIndex === -1) {
      alert('❌ Tidak ada transaksi!');
      return;
    }

    const actualIndex = transaksiList.length - 1 - latestIndex;
    const trx = transaksiList[actualIndex];
    anggota.wajib -= trx.tambahWajib;
    anggota.sukarela -= (trx.tambahSukarela + trx.bunga);
    anggota.totalDana = anggota.pokok + anggota.wajib + anggota.sukarela;
    transaksiList.splice(actualIndex, 1);

    triggerSave();
    alert('✅ Transaksi dihapus!');
  } catch (error) {
    console.error('Error deleteInfoAnggota:', error);
  }
}

function hitungSHU() {
  try {
    // ... (kode hitungSHU sama seperti sebelumnya) ...
    // Hanya tambahkan triggerSave() di akhir jika perlu
    triggerSave();
    alert('✅ Kalkulasi SHU selesai!');
  } catch (error) {
    console.error('Error hitungSHU:', error);
  }
}

// ===== SEMUA FUNGSI LAIN (render, update, export) TETAP SAMA =====
// ... (copy semua fungsi renderTableAnggota, updateSelectAnggota, dll dari kode asli) ...

// Pastikan semua fungsi yang mengubah data memanggil: triggerSave()
</script>
