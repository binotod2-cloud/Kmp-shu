<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KMP pasirgombong v 1.7.2</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --primary: #4CAF50;
    --success: #4CAF50;
    --danger: #f44336;
    --warning: #FF9800;
    --info: #2196F3;
    --bg: #f5f7fb;
    --card: white;
  }
  * { box-sizing: border-box; margin:0; padding:0; }
  body { font-family: 'Segoe UI', Arial; background: var(--bg); color: #222; padding: 20px; }
  .container { max-width: 1400px; margin: auto; }
  h2 { text-align: center; margin-bottom: 15px; color: var(--primary); }
  nav { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; justify-content: center; }
  nav button { padding: 10px 16px; border: none; border-radius: 6px; background: var(--primary); color: white; font-weight: 600; cursor: pointer; transition: 0.2s; }
  nav button:hover { background: #45a049; }
  .tab { display: none; background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .tab.active { display: block; }
  .row { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 15px; }
  .row > div { flex: 1; min-width: 160px; }
  label { display: block; margin-bottom: 5px; font-weight: 600; }
  input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
  button { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: 0.2s; }
  .btn-success { background: var(--success); color: white; }
  .btn-success:hover { background: #45a049; }
  .btn-danger { background: var(--danger); color: white; }
  .btn-danger:hover { background: #d32f2f; }
  .btn-save-all { background: var(--warning); color: white; font-weight: bold; }
  .btn-save-all:hover { background: #e68a00; }
  .btn-info { background: var(--info); color: white; }
  .btn-info:hover { background: #1976d2; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  th { background: var(--primary); color: white; }
  .editable { cursor: pointer; }
  .editable:hover { background: #f0f8ff; }
  .info-box { background: #e3f2fd; border-left: 4px solid var(--info); padding: 12px; border-radius: 4px; margin: 15px 0; font-size: 14px; }
  .muted { color: #666; font-style: italic; font-size: 13px; }
  .toggle-btn { background: var(--warning); color: white; font-size: 11px; padding: 4px 8px; margin-left: 8px; }
  .hidden { display: none; }
  #previewArea { background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; padding: 12px; margin: 15px 0; font-size: 13px; }
  .reset-btn { background: var(--danger); }
  .reset-btn:hover { background: #c62828; }
</style>
</head>
<body>

<div class="container">
  <h2>KMP pasirgombong v 1.7.2</h2>
  <nav>
    <button onclick="openTab('anggota')">Data Anggota</button>
    <button onclick="openTab('transaksi')">Simpanan & Riwayat</button>
    <button onclick="openTab('shu')">Kalkulasi SHU</button>
    <button onclick="exportAll()">Export Excel</button>
    <button class="reset-btn" onclick="clearAll()">Reset Data</button>
  </nav>

  <!-- TAB ANGGOTA -->
  <div id="anggota" class="tab active">
    <h3>Data Anggota <button class="toggle-btn" onclick="toggle('form-anggota')">Toggle</button></h3>
    <div id="form-anggota">
      <div class="row">
        <div><label>Tanggal Daftar</label><input type="date" id="tglDaftar"></div>
        <div><label>ID Anggota</label><input type="text" id="idAnggota" placeholder="Auto"></div>
      </div>
      <div class="row">
        <div><label>Nama</label><input type="text" id="namaAnggota"></div>
        <div><label>Pokok (Rp)</label><input type="number" id="pokok" value="100000" min="1" step="1000"></div>
      </div>
      <div class="row">
        <div><label>Wajib Awal (Rp)</label><input type="number" id="wajib" value="50000" min="1" step="1000"></div>
        <div><label>Sukarela Awal (Rp)</label><input type="number" id="sukarela" value="0" min="0" step="1000"></div>
      </div>
      <div>
        <button class="btn-success" onclick="addMember()">Tambah</button>
        <input type="file" id="fileImport" accept=".xlsx" style="display:none;">
        <button class="btn-success" onclick="document.getElementById('fileImport').click()">Import Excel</button>
        <span class="muted">* Pokok & Wajib wajib diisi</span>
      </div>
      <div style="margin:15px 0;">
        <button class="btn-save-all" onclick="saveAllMembers()">Save All Anggota</button>
        <span class="muted">Simpan semua edit sekaligus</span>
      </div>
    </div>
    <table id="tblAnggota">
      <thead><tr>
        <th>Tanggal</th><th>ID</th><th>Nama</th>
        <th>Pokok</th><th>Wajib</th><th>Sukarela</th>
        <th>SHU</th><th>Total</th><th>Aksi</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- TAB TRANSAKSI -->
  <div id="transaksi" class="tab">
    <h3>Transaksi Simpanan</h3>
    <div class="info-box">Bunga sukarela 0.5% per bulan. Gunakan Hitung Bunga untuk massal.</div>
    <div class="row">
      <div><label>Pilih Anggota</label>
        <select id="selMember" onchange="showPreview()"><option value="">-- Pilih --</option></select>
      </div>
      <div><label>Tanggal</label><input type="date" id="tglTrx"></div>
      <div><label>Bunga (%)</label><input type="number" value="0.5" readonly></div>
    </div>
    <div class="row">
      <div><label>+ Wajib</label><input type="number" id="addWajib" min="0" step="1000"></div>
      <div><label>+ Sukarela</label><input type="number" id="addSukarela" min="0" step="1000"></div>
      <div><label>Belanja</label><input type="number" id="belanja" min="0" step="1000"></div>
    </div>
    <div>
      <button class="btn-success" onclick="addTransaction()">Proses</button>
      <button class="btn-info" onclick="showAllMembers()">Update Semua</button>
      <button class="btn-success" onclick="calcInterest(1)">Bunga 1 Bulan</button>
      <button class="btn-success" onclick="calcInterestCustom()">Bunga Custom</button>
      <input type="number" id="bulanCustom" value="12" min="1" style="width:70px;margin-left:8px;">
    </div>
    <h4>Preview <button class="toggle-btn" onclick="toggle('preview')">Toggle</button></h4>
    <div id="preview" class="hidden"></div>

    <div style="margin:15px 0;">
      <button class="btn-save-all" onclick="saveAllTransactions()">Save All Transaksi</button>
      <span class="muted">Simpan semua input di Info Anggota</span>
    </div>

    <h4>Info Anggota <button class="toggle-btn" onclick="toggle('infoTbl')">Toggle</button></h4>
    <table id="infoTbl" class="hidden">
      <thead><tr><th>Tgl</th><th>ID</th><th>Nama</th><th>+Wajib</th><th>+Sukarela</th><th>Bunga</th><th>Setelah</th><th>Belanja</th><th>Aksi</th></tr></thead>
      <tbody></tbody>
    </table>

    <h4>Riwayat <button class="toggle-btn" onclick="toggle('histTbl')">Toggle</button></h4>
    <table id="histTbl" class="hidden">
      <thead><tr><th>Tgl</th><th>ID</th><th>Nama</th><th>+Wajib</th><th>+Sukarela</th><th>Bunga</th><th>Setelah</th><th>Belanja</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- TAB SHU -->
  <div id="shu" class="tab">
    <h3>Kalkulasi SHU</h3>
    <div class="info-box">SHU dibagi berdasarkan modal & belanja. Pos lain sesuai %.</div>
    <div class="row">
      <div><label>Periode</label><select id="periode" onchange="changePeriod()"><option value="bulan">Bulanan</option><option value="tahun">Tahunan</option></select></div>
      <div><label>Bulan/Tahun</label><input type="month" id="bulanSHU"></div>
      <div><label>Total SHU</label><input type="number" id="totalSHU" value="10000000" min="0"></div>
    </div>
    <h4>Persentase (%)</h4>
    <div class="row">
      <div><label>Modal</label><input type="number" id="pModal" value="40" step="0.1"></div>
      <div><label>Belanja</label><input type="number" id="pBelanja" value="5" step="0.1"></div>
      <div><label>Cadangan</label><input type="number" id="pCadangan" value="20" step="0.1"></div>
    </div>
    <div>
      <button class="btn-success" onclick="hitungSHU()">Hitung SHU</button>
      <span id="totalPct" class="muted"></span>
    </div>
    <table id="tblSHU"><thead><tr><th>ID</th><th>Nama</th><th>Modal</th><th>Belanja</th><th>SHU Modal</th><th>SHU Belanja</th><th>Total</th></tr></thead><tbody></tbody></table>
    <table id="tblPos"><thead><tr><th>Pos</th><th>%</th><th>Nominal</th></tr></thead><tbody></tbody></table>
    <button class="btn-success" onclick="exportSHU()">Export SHU</button>
  </div>
</div>

<script>
const STORAGE = 'kmp_v172';
let members = [], transactions = [];

// INIT
document.addEventListener('DOMContentLoaded', () => {
  const today = new Date().toISOString().split('T')[0];
  ['tglDaftar', 'tglTrx'].forEach(id => document.getElementById(id).value = today);
  document.getElementById('bulanSHU').value = today.slice(0,7);
  loadData();
  renderAll();
});

// TAB
function openTab(tab) { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.getElementById(tab).classList.add('active'); }
function toggle(id) { document.getElementById(id).classList.toggle('hidden'); }

// STORAGE
function saveData() { localStorage.setItem(STORAGE, JSON.stringify({members, transactions})); }
function loadData() {
  const data = JSON.parse(localStorage.getItem(STORAGE) || '{}');
  members = data.members || []; transactions = data.transactions || [];
}
function clearAll() { if(confirm('Hapus semua data?')) { localStorage.removeItem(STORAGE); members = []; transactions = []; renderAll(); } }

// RENDER
function renderAll() {
  renderMembers(); renderSelect(); renderInfo(); renderHistory(); renderSHU();
}
function formatRp(n) { return 'Rp ' + Math.round(n).toLocaleString('id-ID'); }

// === ANGGOTA ===
function addMember() {
  const tgl = document.getElementById('tglDaftar').value;
  let id = document.getElementById('idAnggota').value.trim() || 'A' + String(members.length+1).padStart(3,'0');
  const nama = document.getElementById('namaAnggota').value.trim();
  const pokok = +document.getElementById('pokok').value || 0;
  const wajib = +document.getElementById('wajib').value || 0;
  const sukarela = +document.getElementById('sukarela').value || 0;

  if (!tgl || !nama || pokok <= 0 || wajib <= 0) return alert('Data tidak lengkap!');
  if (members.some(m => m.id === id)) return alert('ID sudah ada!');

  const member = { tgl, id, nama, pokok, wajib, sukarela, shu: 0, total: pokok + wajib + sukarela };
  members.push(member);
  transactions.push({ tgl, id, nama, wajib, sukarela, bunga: 0, setelah: sukarela, belanja: 0, ket: 'Daftar' });
  saveData(); renderAll();
  document.getElementById('idAnggota').value = ''; document.getElementById('namaAnggota').value = '';
}

function renderMembers() {
  const tbody = document.querySelector('#tblAnggota tbody');
  tbody.innerHTML = '';
  members.forEach((m, i) => {
    tbody.innerHTML += `<tr>
      <td onclick="edit(${i},'tgl',this)">${m.tgl}</td>
      <td>${m.id}</td>
      <td onclick="edit(${i},'nama',this)">${m.nama}</td>
      <td onclick="edit(${i},'pokok',this)">${formatRp(m.pokok)}</td>
      <td onclick="edit(${i},'wajib',this)">${formatRp(m.wajib)}</td>
      <td onclick="edit(${i},'sukarela',this)">${formatRp(m.sukarela)}</td>
      <td onclick="edit(${i},'shu',this)">${formatRp(m.shu)}</td>
      <td><strong>${formatRp(m.total + m.shu)}</strong></td>
      <td><button class="btn-success" onclick="saveMember(${i})">Simpan</button> <button class="btn-danger" onclick="delMember(${i})">Hapus</button></td>
    </tr>`;
  });
}

function edit(i, field, cell) {
  const val = members[i][field];
  const type = field === 'tgl' ? 'date' : 'text';
  cell.innerHTML = `<input type="${type}" value="${val}" id="e-${field}-${i}" style="width:100%">`;
}

function saveMember(i) {
  const m = members[i];
  const fields = ['tgl','nama','pokok','wajib','sukarela','shu'];
  fields.forEach(f => {
    const inp = document.getElementById(`e-${f}-${i}`);
    if (inp) m[f] = f === 'tgl' ? inp.value : f === 'nama' ? inp.value.trim() : +inp.value || 0;
  });
  if (!m.nama || m.pokok <= 0 || m.wajib <= 0) return alert('Data tidak valid!');
  m.total = m.pokok + m.wajib + m.sukarela;
  saveData(); renderAll();
}

function delMember(i) {
  if (!confirm('Hapus?')) return;
  const id = members[i].id;
  members.splice(i,1);
  transactions = transactions.filter(t => t.id !== id);
  saveData(); renderAll();
}

function saveAllMembers() {
  let saved = 0;
  members.forEach((m, i) => {
    const inputs = ['tgl','nama','pokok','wajib','sukarela','shu'].map(f => document.getElementById(`e-${f}-${i}`));
    if (!inputs.some(x => x)) return;
    inputs.forEach((inp, j) => { if (inp) m[ ['tgl','nama','pokok','wajib','sukarela','shu'][j] ] = inp.value; });
    if (m.nama && m.pokok > 0 && m.wajib > 0) { m.total = m.pokok + m.wajib + m.sukarela; saved++; }
  });
  if (saved) { saveData(); renderAll(); alert(`Tersimpan ${saved} anggota!`); }
  else alert('Tidak ada perubahan.');
}

// === TRANSAKSI ===
function renderSelect() {
  const sel = document.getElementById('selMember');
  sel.innerHTML = '<option value="">-- Pilih --</option>';
  members.forEach((m,i) => sel.innerHTML += `<option value="${i}">${m.id} - ${m.nama}</option>`);
}

function showPreview() {
  const i = document.getElementById('selMember').value;
  const div = document.getElementById('preview');
  if (i === '') { div.innerHTML = 'Pilih anggota...'; return; }
  const m = members[i];
  div.innerHTML = `<strong>${m.nama}</strong><br>Pokok: ${formatRp(m.pokok)} | Wajib: ${formatRp(m.wajib)} | Sukarela: ${formatRp(m.sukarela)} | SHU: ${formatRp(m.shu)} | <strong>Total: ${formatRp(m.total + m.shu)}</strong>`;
}

function addTransaction() {
  const i = document.getElementById('selMember').value;
  const tgl = document.getElementById('tglTrx').value;
  const w = +document.getElementById('addWajib').value || 0;
  const s = +document.getElementById('addSukarela').value || 0;
  const b = +document.getElementById('belanja').value || 0;
  if (i === '' || !tgl || (!w && !s && !b)) return alert('Isi data!');
  const m = members[i];
  const bunga = m.sukarela * 0.005;
  m.sukarela += bunga + s; m.wajib += w; m.total = m.pokok + m.wajib + m.sukarela;
  transactions.push({ tgl, id: m.id, nama: m.nama, wajib: w, sukarela: s, bunga, setelah: m.sukarela, belanja: b, ket: 'Transaksi' });
  saveData(); renderAll(); resetInputs();
}

function resetInputs() { ['addWajib','addSukarela','belanja'].forEach(id => document.getElementById(id).value = 0); }

function showAllMembers() {
  const div = document.getElementById('preview');
  let html = '<h4>Semua Anggota</h4>';
  members.forEach(m => html += `<div style="border-bottom:1px solid #eee;padding:8px;"><strong>${m.nama} (${m.id})</strong><br>Pokok: ${formatRp(m.pokok)} | Wajib: ${formatRp(m.wajib)} | Sukarela: ${formatRp(m.sukarela)} | SHU: ${formatRp(m.shu)} | Total: <strong>${formatRp(m.total + m.shu)}</strong></div>`);
  div.innerHTML = html;
}

function calcInterest(months) {
  const tgl = document.getElementById('tglTrx').value;
  if (!tgl) return alert('Isi tanggal!');
  let cnt = 0;
  members.forEach(m => {
    if (m.sukarela > 0) {
      const b = m.sukarela * 0.005;
      m.sukarela += b; m.total += b;
      transactions.push({ tgl, id: m.id, nama: m.nama, wajib: 0, sukarela: 0, bunga: b, setelah: m.sukarela, belanja: 0, ket: 'Bunga' });
      cnt++;
    }
  });
  saveData(); renderAll(); alert(`Bunga ${months} bulan: ${cnt} anggota`);
}

function calcInterestCustom() {
  const months = +document.getElementById('bulanCustom').value || 1;
  calcInterest(months);
}

function renderInfo() {
  const tbody = document.querySelector('#infoTbl tbody');
  tbody.innerHTML = '';
  members.forEach((m,i) => {
    const last = transactions.filter(t => t.id === m.id).slice(-1)[0] || { tgl: m.tgl, wajib: 0, sukarela: 0, bunga: 0, setelah: m.sukarela, belanja: 0 };
    tbody.innerHTML += `<tr>
      <td>${last.tgl}</td><td>${m.id}</td><td>${m.nama}</td>
      <td><input type="number" id="iw-${i}" value="${last.wajib}" step="1000"></td>
      <td><input type="number" id="is-${i}" value="${last.sukarela}" step="1000"></td>
      <td>${formatRp(last.bunga)}</td><td>${formatRp(last.setelah)}</td>
      <td><input type="number" id="ib-${i}" value="${last.belanja}" step="1000"></td>
      <td><button class="btn-success" onclick="saveTrx(${i})">Simpan</button></td>
    </tr>`;
  });
}

function saveTrx(i) {
  const tgl = document.getElementById('tglTrx').value;
  const w = +document.getElementById(`iw-${i}`).value || 0;
  const s = +document.getElementById(`is-${i}`).value || 0;
  const b = +document.getElementById(`ib-${i}`).value || 0;
  if (!tgl || (!w && !s && !b)) return alert('Isi minimal satu!');
  const m = members[i];
  m.wajib += w; m.sukarela += s; m.total = m.pokok + m.wajib + m.sukarela;
  transactions.push({ tgl, id: m.id, nama: m.nama, wajib: w, sukarela: s, bunga: 0, setelah: m.sukarela, belanja: b, ket: 'Manual' });
  saveData(); renderAll();
}

function saveAllTransactions() {
  const tgl = document.getElementById('tglTrx').value;
  if (!tgl) return alert('Isi tanggal!');
  let saved = 0;
  members.forEach((m,i) => {
    const w = +document.getElementById(`iw-${i}`)?.value || 0;
    const s = +document.getElementById(`is-${i}`)?.value || 0;
    const b = +document.getElementById(`ib-${i}`)?.value || 0;
    if (w || s || b) {
      m.wajib += w; m.sukarela += s; m.total = m.pokok + m.wajib + m.sukarela;
      transactions.push({ tgl, id: m.id, nama: m.nama, wajib: w, sukarela: s, bunga: 0, setelah: m.sukarela, belanja: b, ket: 'Save All' });
      saved++;
    }
  });
  if (saved) { saveData(); renderAll(); alert(`Tersimpan ${saved} transaksi!`); }
  else alert('Tidak ada input.');
}

function renderHistory() {
  const tbody = document.querySelector('#histTbl tbody');
  tbody.innerHTML = '';
  [...transactions].reverse().forEach(t => {
    tbody.innerHTML += `<tr>
      <td>${t.tgl}</td><td>${t.id}</td><td>${t.nama}</td>
      <td>${formatRp(t.wajib)}</td><td>${formatRp(t.sukarela)}</td>
      <td>${formatRp(t.bunga)}</td><td>${formatRp(t.setelah)}</td>
      <td>${formatRp(t.belanja)}</td>
    </tr>`;
  });
}

// === SHU ===
function changePeriod() {
  const p = document.getElementById('periode').value;
  const inp = document.getElementById('bulanSHU');
  if (p === 'tahun') { inp.type = 'number'; inp.placeholder = '2025'; inp.value = new Date().getFullYear(); }
  else { inp.type = 'month'; inp.value = new Date().toISOString().slice(0,7); }
}

function hitungSHU() {
  const total = +document.getElementById('totalSHU').value || 0;
  if (total <= 0) return alert('Isi total SHU!');
  const pct = { modal: +document.getElementById('pModal').value, belanja: +document.getElementById('pBelanja').value, cadangan: +document.getElementById('pCadangan').value };
  const sum = Object.values(pct).reduce((a,b)=>a+b,0);
  document.getElementById('totalPct').textContent = `Total: ${sum}%`;
  if (Math.abs(sum-100)>0.1) return alert('Total % harus 100!');

  const shuModal = total * pct.modal / 100;
  const totalModal = members.reduce((s,m)=>s+m.pokok+m.wajib,0);
  const shuBelanja = total * pct.belanja / 100;
  const belanjaTotal = transactions.reduce((s,t)=>s+t.belanja,0);
  const belanjaById = {}; transactions.forEach(t=> belanjaById[t.id] = (belanjaById[t.id]||0) + t.belanja);

  const tbody = document.querySelector('#tblSHU tbody'); tbody.innerHTML = '';
  members.forEach(m => {
    const modal = m.pokok + m.wajib;
    const sm = totalModal > 0 ? (modal/totalModal)*shuModal : 0;
    const bel = belanjaById[m.id] || 0;
    const sb = belanjaTotal > 0 && bel > 0 ? (bel/belanjaTotal)*shuBelanja : 0;
    const tot = sm + sb;
    m.shu = tot;
    tbody.innerHTML += `<tr><td>${m.id}</td><td>${m.nama}</td><td>${formatRp(modal)}</td><td>${formatRp(bel)}</td><td>${formatRp(sm)}</td><td>${formatRp(sb)}</td><td><strong>${formatRp(tot)}</strong></td></tr>`;
  });

  const posTbody = document.querySelector('#tblPos tbody'); posTbody.innerHTML = '';
  ['Cadangan'].forEach(pos => {
    const val = total * pct.cadangan / 100;
    posTbody.innerHTML += `<tr><td>${pos}</td><td>${pct.cadangan}%</td><td>${formatRp(val)}</td></tr>`;
  });
  saveData(); renderAll();
}

// === EXPORT ===
function exportAll() {
  const wb = XLSX.utils.book_new();
  const ws1 = XLSX.utils.json_to_sheet(members.map(m=>({Tanggal:m.tgl,ID:m.id,Nama:m.nama,Pokok:m.pokok,Wajib:m.wajib,Sukarela:m.sukarela,SHU:m.shu,Total:m.total+m.shu})));
  XLSX.utils.book_append_sheet(wb, ws1, 'Anggota');
  const ws2 = XLSX.utils.json_to_sheet(transactions.map(t=>({Tanggal:t.tgl,ID:t.id,Nama:t.nama,'+Wajib':t.wajib,'+Sukarela':t.sukarela,Bunga:t.bunga,Setelah:t.setelah,Belanja:t.belanja})));
  XLSX.utils.book_append_sheet(wb, ws2, 'Transaksi');
  XLSX.writeFile(wb, 'Koperasi_Full.xlsx');
}

function exportSHU() {
  const wb = XLSX.utils.book_new();
  const rows = Array.from(document.querySelectorAll('#tblSHU tbody tr')).map(tr => {
    const cells = tr.cells;
    return {ID:cells[0].textContent, Nama:cells[1].textContent, Modal:+cells[2].textContent.replace(/\D/g,''), Belanja:+cells[3].textContent.replace(/\D/g,''), 'SHU Modal':+cells[4].textContent.replace(/\D/g,''), 'SHU Belanja':+cells[5].textContent.replace(/\D/g,''), Total:+cells[6].textContent.replace(/\D/g,'')};
  });
  const ws = XLSX.utils.json_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, 'SHU');
  XLSX.writeFile(wb, 'Laporan_SHU.xlsx');
}

// IMPORT
document.getElementById('fileImport').onchange = function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const data = new Uint8Array(ev.target.result);
      const wb = XLSX.read(data, {type:'array'});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet);
      json.forEach(row => {
        if (row.ID && row.Nama && row.Pokok >= 0 && row.Wajib >= 0) {
          const id = row.ID;
          if (members.some(m => m.id === id)) return;
          const m = { tgl: row.Tanggal || new Date().toISOString().slice(0,10), id, nama: row.Nama, pokok: +row.Pokok, wajib: +row.Wajib, sukarela: +row.Sukarela || 0, shu: 0, total: 0 };
          m.total = m.pokok + m.wajib + m.sukarela;
          members.push(m);
        }
      });
      saveData(); renderAll(); alert('Import sukses!');
    } catch (err) { alert('Gagal import: ' + err.message); }
  };
  reader.readAsArrayBuffer(file);
};
</script>
</body>
</html>
