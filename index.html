<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KMP Pasirgombong</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family: 'Segoe UI', sans-serif; background:#f4f6f9; color:#333; padding:20px; }
    .container { max-width:1200px; margin:auto; background:white; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.1); overflow:hidden; }
    header { background:#1a73e8; color:white; padding:20px; text-align:center; }
    nav { display:flex; flex-wrap:wrap; gap:8px; padding:15px; background:#f1f3f5; border-bottom:1px solid #ddd; }
    nav button { padding:10px 16px; border:none; border-radius:6px; background:#4CAF50; color:white; font-weight:600; cursor:pointer; }
    nav button:hover { background:#45a049; }
    nav button.active { background:#1a73e8; }
    .tab { padding:20px; display:none; }
    .tab.active { display:block; }
    .row { display:flex; gap:15px; margin-bottom:15px; flex-wrap:wrap; }
    .row > div { flex:1; min-width:180px; }
    label { display:block; margin-bottom:5px; font-weight:600; color:#555; }
    input, select { width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; font-size:14px; }
    button { padding:10px 16px; border:none; border-radius:6px; cursor:pointer; font-weight:600; }
    .btn { background:#2196F3; color:white; }
    .btn:hover { background:#0b7dda; }
    .btn-success { background:#4CAF50; color:white; }
    .btn-danger { background:#f44336; color:white; }
    table { width:100%; border-collapse:collapse; margin-top:15px; }
    th, td { border:1px solid #ddd; padding:10px; text-align:center; }
    th { background:#1a73e8; color:white; }
    .info { background:#e3f2fd; padding:12px; border-radius:6px; margin:15px 0; border-left:4px solid #2196F3; font-size:14px; }
    .hidden { display:none; }
    .toggle { font-size:12px; background:#ff9800; color:white; padding:5px 10px; }
    .preview { background:#fff8e1; padding:12px; border-radius:6px; border:1px solid #ffca28; font-size:13px; margin-top:10px; }
  </style>
</head>
<body>
  <div class="container">
    <header><h1>KMP Pasirgombong v2.0</h1></header>
    <nav>
      <button onclick="openTab('anggota')" class="active">Anggota</button>
      <button onclick="openTab('transaksi')">Transaksi</button>
      <button onclick="openTab('shu')">SHU</button>
      <button onclick="exportAll()" class="btn">Export Excel</button>
      <button onclick="hapusSemua()" style="background:#f44336;">Hapus Data</button>
    </nav>

    <!-- ANGGOTA -->
    <div id="anggota" class="tab active">
      <h3>Tambah Anggota</h3>
      <div class="row">
        <div><label>Tanggal</label><input type="date" id="tglDaftar"></div>
        <div><label>ID (Kosongkan = Auto)</label><input type="text" id="idAnggota" placeholder="A001"></div>
      </div>
      <div class="row">
        <div><label>Nama</label><input type="text" id="namaAnggota"></div>
        <div><label>Pokok (min 1.000)</label><input type="number" id="pokok" value="100000" min="1000"></div>
      </div>
      <div class="row">
        <div><label>Wajib (min 1.000)</label><input type="number" id="wajib" value="50000" min="1000"></div>
        <div><label>Sukarela</label><input type="number" id="sukarela" value="0" min="0"></div>
      </div>
      <button class="btn-success" onclick="tambah()">Tambah</button>
      <input type="file" id="importFile" accept=".xlsx" style="display:none">
      <button onclick="document.getElementById('importFile').click()" class="btn">Import Excel</button>

      <h3 style="margin-top:25px">Daftar Anggota</h3>
      <table id="tabelAnggota">
        <thead><tr><th>Tanggal</th><th>ID</th><th>Nama</th><th>Pokok</th><th>Wajib</th><th>Sukarela</th><th>SHU</th><th>Total</th><th>Aksi</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- TRANSAKSI -->
    <div id="transaksi" class="tab">
      <h3>Transaksi</h3>
      <div class="info">Bunga 0.5% otomatis tiap transaksi. Gunakan tombol bunga untuk massal.</div>
      <div class="row">
        <div><label>Anggota</label><select id="pilihAnggota"><option value="">-- Pilih --</option></select></div>
        <div><label>Tanggal</label><input type="date" id="tglTrx"></div>
      </div>
      <div class="row">
        <div><label>+ Wajib</label><input type="number" id="addWajib" value="0"></div>
        <div><label>+ Sukarela</label><input type="number" id="addSukarela" value="0"></div>
        <div><label>Belanja</label><input type="number" id="belanja" value="0"></div>
      </div>
      <button class="btn-success" onclick="prosesTrx()">Proses</button>
      <button class="btn" onclick="lihatSemua()">Lihat Semua</button>
      <button class="btn-success" onclick="bunga1Bulan()">Bunga 1 Bulan</button>

      <div class="preview" id="preview">Pilih anggota...</div>

      <h4 style="margin-top:20px">Riwayat <button class="toggle" onclick="toggle('riwayat')">Hide</button></h4>
      <table id="riwayat" class="hidden">
        <thead><tr><th>Tanggal</th><th>ID</th><th>Nama</th><th>+Wajib</th><th>+Sukarela</th><th>Bunga</th><th>Sukarela</th><th>Belanja</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- SHU -->
    <div id="shu" class="tab">
      <h3>Hitung SHU</h3>
      <div class="row">
        <div><label>Total SHU</label><input type="number" id="totalSHU" value="10000000"></div>
      </div>
      <button class="btn-success" onclick="hitungSHU()">Hitung</button>
      <table id="tabelSHU" style="margin-top:15px">
        <thead><tr><th>ID</th><th>Nama</th><th>Modal</th><th>Belanja</th><th>SHU Modal</th><th>SHU Belanja</th><th>Total</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    let data = [], trx = [];
    const KEY = 'kmp_data_v2';

    function simpan() { localStorage.setItem(KEY, JSON.stringify({data, trx})); }
    function muat() {
      const d = localStorage.getItem(KEY);
      if (d) { const o = JSON.parse(d); data = o.data || []; trx = o.trx || []; }
    }
    function hapusSemua() { if (confirm('Hapus semua?')) { localStorage.removeItem(KEY); location.reload(); } }

    window.onload = () => {
      const t = new Date().toISOString().split('T')[0];
      document.getElementById('tglDaftar').value = t;
      document.getElementById('tglTrx').value = t;
      muat(); render(); updateSelect();
    };

    function openTab(id) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelector(`nav button[onclick="openTab('${id}')"]`).classList.add('active');
    }

    function fmt(n) { return 'Rp ' + Math.round(n).toLocaleString('id-ID'); }

    function tambah() {
      const tgl = document.getElementById('tglDaftar').value;
      let id = document.getElementById('idAnggota').value.trim();
      const nama = document.getElementById('namaAnggota').value.trim();
      const p = +document.getElementById('pokok').value;
      const w = +document.getElementById('wajib').value;
      const s = +document.getElementById('sukarela').value;

      if (!tgl || !nama || p < 1000 || w < 1000) return alert('Isi lengkap! Pokok & Wajib min 1.000');
      if (!id) id = 'A' + String(data.length + 1).padStart(3, '0');
      if (data.some(a => a.id === id)) return alert('ID sudah ada!');

      const a = {tgl, id, nama, pokok:p, wajib:w, sukarela:s, shu:0};
      a.total = p + w + s;
      data.push(a);
      trx.push({tgl, id, nama, tambahWajib:w, tambahSukarela:s, bunga:0, sukarelaSetelah:s, belanja:0});
      resetForm(); render(); updateSelect(); simpan();
      alert('Ditambah!');
    }

    function resetForm() {
      document.getElementById('idAnggota').value = '';
      document.getElementById('namaAnggota').value = '';
      document.getElementById('pokok').value = '100000';
      document.getElementById('wajib').value = '50000';
      document.getElementById('sukarela').value = '0';
    }

    function render() {
      const tb = document.querySelector('#tabelAnggota tbody');
      tb.innerHTML = '';
      data.forEach((a, i) => {
        tb.innerHTML += `<tr>
          <td>${a.tgl}</td><td>${a.id}</td><td>${a.nama}</td>
          <td>${fmt(a.pokok)}</td><td>${fmt(a.wajib)}</td><td>${fmt(a.sukarela)}</td>
          <td>${fmt(a.shu)}</td><td><strong>${fmt(a.total + a.shu)}</strong></td>
          <td><button class="btn-danger" onclick="hapus(${i})">Hapus</button></td>
        </tr>`;
      });
    }

    function hapus(i) {
      if (confirm('Hapus ' + data[i].nama + '?')) {
        const id = data[i].id;
        data.splice(i, 1);
        trx = trx.filter(t => t.id !== id);
        render(); updateSelect(); simpan();
      }
    }

    function updateSelect() {
      const s = document.getElementById('pilihAnggota');
      s.innerHTML = '<option value="">-- Pilih --</option>';
      data.forEach((a, i) => s.innerHTML += `<option value="${i}">${a.id} - ${a.nama}</option>`);
    }

    function prosesTrx() {
      const i = document.getElementById('pilihAnggota').value;
      const tgl = document.getElementById('tglTrx').value;
      const tw = +document.getElementById('addWajib').value || 0;
      const ts = +document.getElementById('addSukarela').value || 0;
      const b = +document.getElementById('belanja').value || 0;
      if (!i || !tgl || (tw + ts + b === 0)) return853 alert('Isi transaksi!');

      const a = data[i];
      const bunga = a.sukarela * 0.005;
      a.sukarela += bunga + ts;
      a.wajib += tw;
      a.total = a.pokok + a.wajib + a.sukarela;

      trx.push({tgl, id:a.id, nama:a.nama, tambahWajib:tw, tambahSukarela:ts, bunga, sukarelaSetelah:a.sukarela, belanja:b});
      document.getElementById('addWajib').value = document.getElementById('addSukarela').value = document.getElementById('belanja').value = 0;
      render(); updatePreview(); simpan();
      alert('OK!');
    }

    function updatePreview() {
      const i = document.getElementById('pilihAnggota').value;
      const p = document.getElementById('preview');
      if (!i) { p.innerHTML = 'Pilih anggota...'; return; }
      const a = data[i];
      p.innerHTML = `<strong>${a.nama}</strong><br>Pokok: ${fmt(a.pokok)} | Wajib: ${fmt(a.wajib)}<br>Sukarela: ${fmt(a.sukarela)} | Total: <strong>${fmt(a.total + a.shu)}</strong>`;
    }

    function lihatSemua() {
      let h = '<h4>Semua Anggota</h4>';
      data.forEach(a => h += `<div style="margin:8px 0;padding:8px;background:#f9f9f9"><strong>${a.nama}</strong>: ${fmt(a.total + a.shu)}</div>`);
      document.getElementById('preview').innerHTML = h;
    }

    function bunga1Bulan() {
      const tgl = document.getElementById('tglTrx').value;
      if (!tgl) return alert('Pilih tanggal!');
      data.forEach(a => {
        if (a.sukarela > 0) {
          const b = a.sukarela * 0.005;
          a.sukarela += b; a.total = a.pokok + a.wajib + a.sukarela;
          trx.push({tgl, id:a.id, nama:a.nama, tambahWajib:0, tambahSukarela:0, bunga:b, sukarelaSetelah:a.sukarela, belanja:0});
        }
      });
      render(); simpan(); alert('Bunga 1 bulan diterapkan!');
    }

    function toggle(id) { document.getElementById(id).classList.toggle('hidden'); }

    function hitungSHU() {
      const profit = +document.getElementById('totalSHU').value || 0;
      if (!profit) return alert('Isi total SHU!');
      const modalTotal = data.reduce((s,a) => s + a.pokok + a.wajib, 0);
      const belanjaTotal = trx.reduce((s,t) => s + t.belanja, 0);
      const mapBelanja = {}; trx.forEach(t => mapBelanja[t.id] = (mapBelanja[t.id] || 0) + t.belanja);

      const shuModal = profit * 0.4;
      const shuBelanja = profit * 0.05;

      const tb = document.querySelector('#tabelSHU tbody'); tb.innerHTML = '';
      data.forEach(a => {
        const modal = a.pokok + a.wajib;
        const sm = modalTotal > 0 ? (modal / modalTotal) * shuModal : 0;
        const bel = mapBelanja[a.id] || 0;
        const sb = belanjaTotal > 0 && bel > 0 ? (bel / belanjaTotal) * shuBelanja : 0;
        const total = sm + sb;
        a.shu = total;
        tb.innerHTML += `<tr><td>${a.id}</td><td>${a.nama}</td><td>${fmt(modal)}</td><td>${fmt(bel)}</td><td>${fmt(sm)}</td><td>${fmt(sb)}</td><td><strong>${fmt(total)}</strong></td></tr>`;
      });
      render(); simpan();
    }

    function exportAll() {
      if (!data.length) return alert('Kosong!');
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.map(a => ({
        Tanggal: a.tgl, ID: a.id, Nama: a.nama, Pokok: a.pokok, Wajib: a.wajib, Sukarela: a.sukarela, SHU: a.shu, Total: a.total + a.shu
      })), 'Anggota');
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(trx.slice().reverse().map(t => ({
        Tanggal: t.tgl, ID: t.id, Nama: t.nama, 'Tambah Wajib': t.tambahWajib, 'Tambah Sukarela': t.tambahSukarela,
        Bunga: t.bunga, 'Sukarela Setelah': t.sukarelaSetelah, Belanja: t.belanja
      })), 'Transaksi');
      XLSX.writeFile(wb, 'Koperasi_Pasirgombong.xlsx');
    }

    document.getElementById('importFile').onchange = e => {
      const f = e.target.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = ev => {
        try {
          const wb = XLSX.read(ev.target.result, {type:'array'});
          const ws = wb.Sheets['Anggota'];
          if (ws) {
            const json = XLSX.utils.sheet_to_json(ws);
            data = json.map(x => ({
              tgl: x.Tanggal, id: x.ID, nama: x.Nama,
              pokok: +x.Pokok || 0, wajib: +x.Wajib || 0, sukarela: +x.Sukarela || 0, shu: +x.SHU || 0
            }));
            data.forEach(a => a.total = a.pokok + a.wajib + a.sukarela);
            render(); updateSelect(); simpan();
            alert('Import berhasil!');
          }
        } catch { alert('Gagal import!'); }
      };
      r.readAsArrayBuffer(f);
    };
  </script>
</body>
</html>
