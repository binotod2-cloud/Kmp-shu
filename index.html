<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KMP Pasirgombong v 1.8</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { font-family: Arial; margin:20px; background:#f5f7fb; color:#222; }
h2,h3,h4 { margin:10px 0; }
.container { max-width:1400px; margin:auto; }
nav button { margin-right:8px; padding:8px 16px; background:#4CAF50; color:white; border:none; border-radius:4px; }
nav button:hover { background:#45a049; }
.row, .row3 { display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
.row div, .row3 div { flex:1; min-width:150px; display:flex; flex-direction:column; }
table { width:100%; border-collapse:collapse; margin-top:10px; background:white; }
table, th, td { border:1px solid #ddd; }
th { background:#4CAF50; color:white; padding:8px; text-align:center; }
td { padding:6px; text-align:center; }
input, select { width:100%; padding:6px; border:1px solid #ccc; border-radius:4px; box-sizing:border-box; }
.small { font-size:12px; }
.muted { color:#666; font-style:italic; }
button { cursor:pointer; padding:8px 16px; border:none; border-radius:4px; background:#2196F3; color:white; }
button:hover { background:#0b7dda; }
.btn-success { background:#4CAF50; }
.btn-success:hover { background:#45a049; }
.btn-danger { background:#f44336; }
.btn-danger:hover { background:#da190b; }
#previewArea { background:#fff3cd; padding:10px; border-radius:4px; border:1px solid #ffc107; }
.info-box { background:#e3f2fd; padding:10px; border-radius:4px; margin:10px 0; border-left:4px solid #2196F3; }
.toggle-btn { background:#ff9800; color:white; margin-left:8px; font-size:12px; padding:6px 10px; }
.toggle-btn:hover { background:#e68a00; }
.hidden { display:none; }
.reset-btn { background:#f44336; margin-top:10px; }
.reset-btn:hover { background:#d32f2f; }
.btn-save-all { background:#FF5722; color:white; margin-top:10px; padding:10px 20px; font-weight:bold; }
.btn-save-all:hover { background:#e64a19; }

/* MODAL CUSTOM */
.custom-modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  animation: fadeIn 0.3s;
}
.custom-modal-content {
  background: white;
  margin: 10% auto;
  padding: 0;
  width: 90%;
  max-width: 400px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  animation: slideIn 0.4s;
  overflow: hidden;
}
.custom-modal-header {
  background: linear-gradient(135deg, #2196F3, #0b7dda);
  color: white;
  padding: 20px;
  text-align: center;
  font-size: 1.2rem;
  font-weight: bold;
}
.custom-modal-body {
  padding: 25px;
  font-size: 1rem;
  line-height: 1.5;
  text-align: center;
}
.custom-modal-body strong {
  color: #d32f2f;
  font-size: 1.1rem;
}
.custom-modal-footer {
  padding: 15px 25px;
  text-align: center;
  border-top: 1px solid #eee;
  display: flex;
  gap: 10px;
  justify-content: center;
}
.custom-modal-btn {
  padding: 10px 25px;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  min-width: 100px;
  transition: all 0.3s;
}
.custom-modal-btn.confirm {
  background: #4CAF50;
  color: white;
}
.custom-modal-btn.confirm:hover {
  background: #388E3C;
  transform: translateY(-2px);
}
.custom-modal-btn.cancel {
  background: #f5f5f5;
  color: #333;
  border: 1px solid #ddd;
}
.custom-modal-btn.cancel:hover {
  background: #e0e0e0;
}
@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
@keyframes slideIn { from { transform:translateY(-30px); opacity:0; } to { transform:translateY(0); opacity:1; } }
</style>
</head>
<body>

<!-- CUSTOM MODAL -->
<div id="customModal" class="custom-modal">
  <div class="custom-modal-content">
    <div class="custom-modal-header" id="modalHeader">Konfirmasi</div>
    <div class="custom-modal-body" id="modalBody">
      Apakah Anda yakin?
    </div>
    <div class="custom-modal-footer">
      <button class="custom-modal-btn confirm" id="modalConfirm">Ya</button>
      <button class="custom-modal-btn cancel" id="modalCancel">Tidak</button>
    </div>
  </div>
</div>

<div class="container">
<h2>KMP Pasirgombong v 1.8</h2>
<nav>
  <button onclick="showTab('anggota')">Data Anggota</button>
  <button onclick="showTab('transaksi')">Simpanan & Riwayat</button>
  <button onclick="showTab('shu')">Kalkulasi SHU</button>
  <button onclick="exportToExcel()">Export Excel</button>
  <button class="reset-btn" onclick="confirmReset()">Reset Semua Data</button>
  <button onclick="downloadTemplateExcel()" style="background:#9C27B0;">Download Template</button>
</nav>

<!-- ===== DATA ANGGOTA ===== -->
<div id="tab-anggota">
  <h3>Data Anggota</h3>
  <div class="row">
    <div><label>Tanggal Daftar</label><input type="date" id="daftarTanggal"></div>
    <div><label>ID Anggota</label><input type="text" id="daftarId" placeholder="Auto generate"></div>
  </div>
  <div class="row">
    <div><label>Nama Anggota</label><input type="text" id="daftarNama"></div>
    <div><label>Simpanan Pokok (Rp)</label><input type="text" id="daftarPokok" value="100.000" class="currency-input" placeholder="100.000"></div>
  </div>
  <div class="row">
    <div><label>Simpanan Wajib Awal (Rp)</label><input type="text" id="daftarWajib" value="50.000" class="currency-input" placeholder="50.000"></div>
    <div><label>Simpanan Sukarela Awal (Rp)</label><input type="text" id="daftarSukarela" value="0" class="currency-input" placeholder="0"></div>
  </div>
  <div>
    <button class="btn-success" onclick="tambahAnggota()">Tambah Anggota</button>
    <input type="file" id="importExcel" accept=".xlsx,.xls" onchange="confirmImport()" style="display:none;">
    <button onclick="document.getElementById('importExcel').click()" class="btn-success">Import Excel</button>
    <span class="muted">* Pokok & Wajib wajib diisi (min Rp 1), Sukarela boleh 0</span>
  </div>

  <h4>
    Daftar Anggota 
    <button class="toggle-btn" onclick="toggleSection('section-tabel-anggota')">Toggle</button>
  </h4>
  <div id="section-tabel-anggota">
    <table id="tableAnggota">
      <thead><tr>
        <th>Tanggal</th><th>ID</th><th>Nama</th>
        <th>Simpanan Pokok</th><th>Simpanan Wajib</th><th>Simpanan Sukarela</th>
        <th>SHU</th><th>Total Dana</th><th>Aksi</th>
      </tr></thead>
      <tbody></tbody>
    </table>
    <div style="text-align:center; margin-top:15px;">
      <button class="btn-save-all" onclick="saveAllAnggota()">Save All (Data Anggota)</button>
    </div>
  </div>
</div>

<!-- ===== TRANSAKSI ===== -->
<div id="tab-transaksi" style="display:none">
<h3>Transaksi Simpanan</h3>
<div class="info-box">
  <strong>Info:</strong> Bunga simpanan sukarela otomatis dihitung 0.5% per bulan (compound) pada transaksi reguler. 
  Gunakan tombol Hitung Bunga untuk menghitung bunga secara massal.
</div>

<div class="row3">
  <div><label>Pilih Anggota</label>
    <select id="selAnggota" onchange="updatePreviewAnggota()">
      <option value="">-- Pilih Anggota --</option>
    </select>
  </div>
  <div><label>Tanggal Transaksi</label><input type="date" id="trxTanggal"></div>
  <div><label>Bunga Sukarela (% per bulan)</label><input type="number" id="bungaPersen" value="0.5" step="0.01" min="0" readonly></div>
</div>

<div class="row3">
  <div><label>Tambah Simpanan Wajib (Rp)</label><input type="text" id="inputTambahWajib" value="0" class="currency-input" placeholder="0"></div>
  <div><label>Tambah Simpanan Sukarela (Rp)</label><input type="text" id="inputTambahSukarela" value="0" class="currency-input" placeholder="0"></div>
  <div><label>Tambah Belanja (Rp)</label><input type="text" id="inputBelanja" value="0" class="currency-input" placeholder="0"></div>
</div>

<div>
  <button class="btn-success" onclick="confirmTransaksi()">Proses Transaksi</button>
  <button onclick="updateAllMembers()" style="background:#2196F3;color:white;">Update Semua Anggota</button>
  <button class="btn-success" onclick="confirmInterestOneMonth()">Hitung Bunga 1 Bulan</button>
  <button class="btn-success" onclick="confirmInterestCustomMonths()">Hitung Bunga Custom</button>
  <input type="number" id="customBulan" value="12" min="1" step="1" style="width:80px; margin-left:8px;" placeholder="Bulan">
</div>

<h4>
  Preview Data Anggota
  <button class="toggle-btn" onclick="togglePreview()">Toggle Preview</button>
</h4>
<div id="previewArea" class="small">Pilih anggota untuk melihat detail...</div>

<h4>
  Info Anggota
  <button class="toggle-btn" onclick="toggleTable('tableInfoAnggota')">Toggle Tabel</button>
</h4>
<table id="tableInfoAnggota" class="hidden">
  <thead><tr>
    <th>Tanggal</th><th>ID</th><th>Nama</th>
    <th>Tambah Wajib</th><th>Tambah Sukarela</th>
    <th>Bunga Sukarela</th>
    <th>Sukarela Setelah</th>
    <th>Tambah Belanja</th>
    <th>Aksi</th>
  </tr></thead>
  <tbody></tbody>
</table>
<div style="text-align:center; margin-top:15px;">
  <button class="btn-save-all" onclick="saveAllInfoAnggota()">Save All (Info Anggota)</button>
</div>

<h4>
  Riwayat Transaksi
  <button class="toggle-btn" onclick="toggleTable('tableTransaksi')">Toggle Tabel</button>
</h4>
<table id="tableTransaksi" class="hidden">
  <thead><tr>
    <th>Tanggal</th><th>ID</th><th>Nama</th>
    <th>Tambah Wajib</th><th>Tambah Sukarela</th>
    <th>Bunga Sukarela</th>
    <th>Sukarela Setelah</th>
    <th>Tambah Belanja</th>
  </tr></thead>
  <tbody></tbody>
</table>
</div>

<!-- ===== SHU ===== -->
<div id="tab-shu" style="display:none">
<h3>Kalkulasi SHU (Sisa Hasil Usaha)</h3>
<div class="info-box">
  <strong>Cara Hitung SHU:</strong><br>
  ‚Ä¢ <strong>SHU Modal:</strong> Berdasarkan total simpanan pokok + wajib per anggota<br>
  ‚Ä¢ <strong>SHU Poin Belanja:</strong> Hanya dibagi ke anggota yang belanja, proporsi sesuai belanja masing-masing<br>
  ‚Ä¢ <strong>Pos Lain:</strong> Cadangan, pengurus, pengawas, dll. dibagi sesuai persentase
</div>

<div class="row3">
  <div><label>Periode</label>
    <select id="shuPeriode" onchange="shuPeriodeChange()">
      <option value="bulanan">Bulanan</option>
      <option value="tahunan">Tahunan</option>
    </select>
  </div>
  <div><label>Bulan/Tahun</label><input type="month" id="shuBulan"></div>
  <div><label>Total SHU/Profit (Rp)</label><input type="text" id="shuProfit" value="0" class="currency-input" placeholder="0"></div>
</div>

<h4>Persentase Pembagian SHU (%)</h4>
<div class="row3">
  <div><label>Modal/Simpanan</label><input type="number" id="persModal" value="40" step="0.1" min="0" max="100"></div>
  <div><label>Poin Belanja</label><input type="number" id="persBelanja" value="5" step="0.1" min="0" max="100"></div>
  <div><label>Cadangan</label><input type="number" id="persCadangan" value="20" step="0.1" min="0" max="100"></div>
  <div><label>Pengurus</label><input type="number" id="persPengurus" value="7" step="0.1" min="0" max="100"></div>
  <div><label>Pengawas</label><input type="number" id="persPengawas" value="5" step="0.1" min="0" max="100"></div>
</div>
<div class="row3">
  <div><label>Karyawan</label><input type="number" id="persKaryawan" value="5" step="0.1" min="0" max="100"></div>
  <div><label>Sosial</label><input type="number" id="persSosial" value="5" step="0.1" min="0" max="100"></div>
  <div><label>Pendidikan</label><input type="number" id="persPendidikan" value="3" step="0.1" min="0" max="100"></div>
  <div><label>Dana Pembangunan</label><input type="number" id="persDanaBangun" value="10" step="0.1" min="0" max="100"></div>
</div>

<div>
  <button class="btn-success" onclick="confirmHitungSHU()">Hitung SHU</button>
  <span class="muted" id="totalPersen"></span>
</div>

<h4>SHU per Anggota 
  <button class="toggle-btn" onclick="toggleTable('tableSHU')">Toggle</button>
</h4>
<table id="tableSHU">
  <thead><tr>
    <th>ID</th><th>Nama</th>
    <th>Total Modal (Pokok+Wajib)</th><th>Total Poin Belanja</th>
    <th>SHU dari Modal</th><th>SHU dari Poin Belanja</th>
    <th>Total SHU Diterima</th>
  </tr></thead>
  <tbody></tbody>
</table>

<h4>Pembagian SHU Semua Pos</h4>
<table id="tableSHUPos">
  <thead><tr><th>Pos SHU</th><th>Persentase</th><th>Nominal (Rp)</th></tr></thead>
  <tbody></tbody>
</table>

<div>
  <button class="btn-success" onclick="exportSHUToExcel()">Export SHU ke Excel</button>
</div>
</div>

</div>

<script>
// ===== FUNGSI PARSE CURRENCY YANG BENAR =====
function parseCurrency(value) {
  if (!value && value !== 0) return 0;
  
  const str = value.toString().trim();
  if (str === '' || str === '0') return 0;
  
  // KOPERASI: Hanya RUPIAH PENUH, tidak ada desimal
  // Hapus SEMUA karakter non-digit (titik, koma, spasi, Rp, dll)
  const digitsOnly = str.replace(/[^\d]/g, '');
  const num = parseInt(digitsOnly) || 0;
  
  return num;
}

// ===== FUNGSI PEMBULATAN =====
function bulatkan(num) {
  const parsed = parseFloat(num) || 0;
  return Math.round(parsed);
}

// ===== FUNGSI FORMAT RUPIAH =====
function formatRupiah(angka) {
  if (!angka && angka !== 0) return '0';
  const num = bulatkan(angka);
  return num.toLocaleString('id-ID');
}

// ===== CUSTOM MODAL SYSTEM =====
let modalResolve = null;

function showCustomModal(title, message, isConfirm = false) {
  return new Promise((resolve) => {
    document.getElementById('modalHeader').textContent = title;
    document.getElementById('modalBody').innerHTML = message;
    document.getElementById('customModal').style.display = 'block';
    modalResolve = resolve;
    
    setTimeout(() => document.getElementById('modalConfirm').focus(), 100);
  });
}

function closeModal(result) {
  document.getElementById('customModal').style.display = 'none';
  if (modalResolve) {
    modalResolve(result);
    modalResolve = null;
  }
}

// Event listeners for modal buttons
document.getElementById('modalConfirm').onclick = () => closeModal(true);
document.getElementById('modalCancel').onclick = () => closeModal(false);
document.getElementById('customModal').onclick = (e) => {
  if (e.target.id === 'customModal') closeModal(false);
};

// ===== SETUP CURRENCY INPUTS =====
function setupCurrencyInputs() {
  const currencyInputs = document.querySelectorAll('.currency-input');
  
  currencyInputs.forEach(input => {
    // Format initial value
    if (input.value && input.value !== '0') {
      const numValue = parseCurrency(input.value);
      input.value = formatRupiah(numValue);
      input.dataset.numeric = numValue.toString();
    } else {
      input.dataset.numeric = '0';
    }
    
    // On input (while typing)
    input.addEventListener('input', function(e) {
      // Simpan cursor position
      const cursorPos = this.selectionStart;
      
      // Get raw value tanpa format
      let raw = this.value.replace(/[^\d]/g, '');
      
      // Simpan sebagai number murni
      this.dataset.numeric = raw;
      
      // Format dengan titik ribuan
      if (raw) {
        const num = parseInt(raw);
        this.value = formatRupiah(num);
        
        // Kembalikan cursor ke posisi yang hampir sama
        const newCursorPos = Math.min(cursorPos + 1, this.value.length);
        this.setSelectionRange(newCursorPos, newCursorPos);
      } else {
        this.value = '';
      }
    });
    
    // On blur - pastikan format benar
    input.addEventListener('blur', function() {
      const num = parseCurrency(this.value);
      this.dataset.numeric = num.toString();
      this.value = num === 0 ? '0' : formatRupiah(num);
    });
    
    // On focus - show raw number
    input.addEventListener('focus', function() {
      const num = this.dataset.numeric || '0';
      this.value = num === '0' ? '' : num;
      this.select();
    });
  });
}

function getCurrencyValue(inputId) {
  const input = document.getElementById(inputId);
  if (!input) return 0;
  return parseCurrency(input.dataset.numeric || input.value);
}

// ===== DATA GLOBAL =====
let anggotaList = [];
let transaksiList = [];
const BUNGA_SUKARELA = 0.5;
const STORAGE_KEY = 'kmp_pasirgombong_v18_data';

// ===== LOCAL STORAGE =====
function saveToStorage() {
  try {
    const data = { anggotaList: [...anggotaList], transaksiList: [...transaksiList] };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch (e) { console.warn('Gagal simpan localStorage', e); }
}

function loadFromStorage() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    const data = JSON.parse(raw);
    anggotaList = Array.isArray(data.anggotaList) ? data.anggotaList.map(a => ({
      ...a, lastInterestDate: a.lastInterestDate || a.tgl, shu: a.shu || 0
    })) : [];
    transaksiList = Array.isArray(data.transaksiList) ? data.transaksiList : [];

    // Pastikan setiap anggota punya transaksi awal
    anggotaList.forEach(a => {
      const hasInitialTrx = transaksiList.some(t => 
        t.id === a.id && t.keterangan === 'Pendaftaran Awal'
      );
      if (!hasInitialTrx) {
        transaksiList.unshift({
          tgl: a.tgl,
          id: a.id,
          nama: a.nama,
          tambahWajib: a.wajib,
          tambahSukarela: a.sukarela,
          bunga: 0,
          sukarelaSetelah: a.sukarela,
          belanja: 0,
          keterangan: 'Pendaftaran Awal (Auto-generated)'
        });
      }
    });

    return true;
  } catch (e) {
    console.error('Data lokal rusak', e);
    localStorage.removeItem(STORAGE_KEY);
    return false;
  }
}

// ===== CONFIRMATION FUNCTIONS =====
async function confirmReset() {
  const confirmed = await showCustomModal(
    'Reset Semua Data',
    'Apakah Anda yakin ingin <strong>MENGHAPUS SEMUA DATA</strong>?<br><br>' +
    'Tindakan ini tidak dapat dibatalkan dan semua data akan hilang!'
  );
  if (confirmed) resetAllData();
}

async function confirmImport() {
  const file = document.getElementById('importExcel').files[0];
  if (!file) return;
  
  const confirmed = await showCustomModal(
    'Import Data Excel',
    'Import data dari file: <strong>' + file.name + '</strong><br><br>' +
    'Data lama akan digantikan dengan data dari file ini.<br>' +
    'Lanjutkan import?'
  );
  if (confirmed) importFromExcel();
}

async function confirmTransaksi() {
  const i = document.getElementById('selAnggota').value;
  const tgl = document.getElementById('trxTanggal').value;
  const w = getCurrencyValue('inputTambahWajib');
  const s = getCurrencyValue('inputTambahSukarela');
  const b = getCurrencyValue('inputBelanja');
  
  if (i==='' || !tgl || (w===0 && s===0 && b===0)) {
    await showCustomModal('Peringatan', 'Data tidak lengkap!<br>Isi minimal satu transaksi.');
    return;
  }
  
  const anggota = anggotaList[i];
  const total = w + s + b;
  
  const confirmed = await showCustomModal(
    'Konfirmasi Transaksi',
    `<strong>${anggota.nama} (${anggota.id})</strong><br><br>` +
    `Tanggal: ${tgl}<br>` +
    `Tambah Wajib: ${formatRupiah(w)}<br>` +
    `Tambah Sukarela: ${formatRupiah(s)}<br>` +
    `Tambah Belanja: ${formatRupiah(b)}<br><br>` +
    `<strong>Total Transaksi: ${formatRupiah(total)}</strong><br><br>` +
    'Simpan transaksi ini?'
  );
  
  if (confirmed) {
    prosesTransaksi();
    await showCustomModal('Sukses', 'Transaksi berhasil disimpan!');
  }
}

async function confirmInterestOneMonth() {
  const confirmed = await showCustomModal(
    'Hitung Bunga 1 Bulan',
    'Hitung bunga 0.5% untuk semua anggota yang memiliki simpanan sukarela?<br><br>' +
    'Bunga akan dihitung berdasarkan saldo sukarela saat ini.'
  );
  if (confirmed) {
    applyInterestOneMonth();
    await showCustomModal('Sukses', 'Bunga 1 bulan telah dihitung!');
  }
}

async function confirmInterestCustomMonths() {
  const m = +document.getElementById('customBulan').value || 1;
  if (m < 1) {
    await showCustomModal('Peringatan', 'Jumlah bulan harus minimal 1!');
    return;
  }
  
  const confirmed = await showCustomModal(
    'Hitung Bunga Custom',
    `Hitung bunga 0.5% per bulan untuk <strong>${m} bulan</strong>?<br><br>` +
    'Bunga akan dihitung compound untuk periode yang ditentukan.'
  );
  
  if (confirmed) {
    applyInterestCustomMonths();
    await showCustomModal('Sukses', `Bunga ${m} bulan telah dihitung!`);
  }
}

async function confirmHitungSHU() {
  const totalSHU = getCurrencyValue('shuProfit');
  if (totalSHU <= 0) {
    await showCustomModal('Peringatan', 'Total SHU harus lebih dari 0!');
    return;
  }
  
  const confirmed = await showCustomModal(
    'Hitung SHU',
    `Hitung pembagian SHU sebesar <strong>${formatRupiah(totalSHU)}</strong>?<br><br>` +
    'Perhitungan akan mengikuti persentase yang telah ditentukan.'
  );
  
  if (confirmed) {
    hitungSHU();
    await showCustomModal('Sukses', 'SHU berhasil dihitung!');
  }
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
  const today = new Date();
  document.getElementById('daftarTanggal').valueAsDate = today;
  document.getElementById('trxTanggal').valueAsDate = today;
  document.getElementById('shuBulan').value = today.toISOString().slice(0, 7);

  loadFromStorage();
  setupCurrencyInputs();
  renderTableAnggota();
  updateSelectAnggota();
  renderTableTransaksi();
  renderTableInfoAnggota();
});

// ===== UTILITY =====
function showTab(tab) {
  ['anggota','transaksi','shu'].forEach(t => {
    const el = document.getElementById(`tab-${t}`);
    if (el) el.style.display = t === tab ? 'block' : 'none';
  });
}

function shuPeriodeChange() {
  const per = document.getElementById('shuPeriode').value;
  const input = document.getElementById('shuBulan');
  if (per === 'tahunan') {
    input.type = 'number'; 
    input.placeholder = 'Tahun (misal: 2025)'; 
    input.min = 2020; 
    input.max = 2030;
    input.value = new Date().getFullYear();
  } else {
    input.type = 'month'; 
    input.value = new Date().toISOString().slice(0,7);
  }
}

function toggleSection(id) {
  const el = document.getElementById(id);
  if (el) el.classList.toggle('hidden');
}

function toggleTable(id) {
  const el = document.getElementById(id);
  if (el) el.classList.toggle('hidden');
}

function togglePreview() {
  const el = document.getElementById('previewArea');
  if (el) el.classList.toggle('hidden');
}

function resetTransactionInputs() {
  document.getElementById('inputTambahWajib').value = '0';
  document.getElementById('inputTambahSukarela').value = '0';
  document.getElementById('inputBelanja').value = '0';
  document.getElementById('selAnggota').value = '';
  document.getElementById('previewArea').innerHTML = 'Pilih anggota untuk melihat detail...';
  setupCurrencyInputs();
}

// ===== TRIGGER SAVE =====
function triggerSave() {
  saveToStorage();
  renderTableAnggota();
  updateSelectAnggota();
  renderTableTransaksi();
  renderTableInfoAnggota();
}

// ===== IMPORT/EXPORT =====
async function importFromExcel() {
  const file = document.getElementById('importExcel').files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type:'array'});
      const newAnggotaList = [];
      const newTransaksiList = [];

      // Import Data Anggota
      const wsA = wb.Sheets['Data Anggota'] || wb.Sheets[wb.SheetNames[0]];
      if (wsA) {
        const rows = XLSX.utils.sheet_to_json(wsA, {defval: ''});
        rows.forEach(r => {
          if (r.Tanggal && r.ID && r.Nama && 
              (r['Simpanan Pokok']>=0) && (r['Simpanan Wajib']>=0) && (r['Simpanan Sukarela']>=0)) {
            
            const anggota = {
              tgl: r.Tanggal,
              id: r.ID.toString().trim(),
              nama: r.Nama.toString().trim(),
              pokok: parseCurrency(r['Simpanan Pokok']),
              wajib: parseCurrency(r['Simpanan Wajib']),
              sukarela: parseCurrency(r['Simpanan Sukarela']),
              totalDana: parseCurrency(r['Simpanan Pokok']) + parseCurrency(r['Simpanan Wajib']) + parseCurrency(r['Simpanan Sukarela']),
              lastInterestDate: r.Tanggal,
              shu: 0
            };
            
            // Cek duplikat ID
            if (!newAnggotaList.some(a => a.id === anggota.id)) {
              newAnggotaList.push(anggota);
              
              // Otomatis buat transaksi awal
              newTransaksiList.push({
                tgl: r.Tanggal,
                id: anggota.id,
                nama: anggota.nama,
                tambahWajib: anggota.wajib,
                tambahSukarela: anggota.sukarela,
                bunga: 0,
                sukarelaSetelah: anggota.sukarela,
                belanja: 0,
                keterangan: 'Pendaftaran Awal (Import)'
              });
            }
          }
        });
      }

      // Import Riwayat Transaksi
      const wsT = wb.Sheets['Riwayat Transaksi'] || wb.Sheets[wb.SheetNames[1]];
      if (wsT) {
        const rows = XLSX.utils.sheet_to_json(wsT, {defval: ''});
        rows.forEach(r => {
          if (r.Tanggal && r.ID && r.Nama) {
            const transaksi = {
              tgl: r.Tanggal,
              id: r.ID.toString().trim(),
              nama: r.Nama.toString().trim(),
              tambahWajib: parseCurrency(r['Tambah Wajib']),
              tambahSukarela: parseCurrency(r['Tambah Sukarela']),
              bunga: parseCurrency(r['Bunga Sukarela']),
              sukarelaSetelah: parseCurrency(r['Sukarela Setelah']),
              belanja: parseCurrency(r['Tambah Belanja'] || r['Poin Belanja'] || 0),
              keterangan: r.Keterangan || 'Transaksi Import'
            };
            
            // Cek apakah anggota ada
            if (newAnggotaList.some(a => a.id === transaksi.id)) {
              newTransaksiList.push(transaksi);
            }
          }
        });
      }

      if (newAnggotaList.length === 0) {
        await showCustomModal('Import Gagal', 'Tidak ada data anggota yang valid ditemukan!');
        return;
      }

      // Update data global
      anggotaList = newAnggotaList;
      transaksiList = newTransaksiList;

      // Update lastInterestDate
      anggotaList.forEach(a => {
        const transaksiAnggota = transaksiList.filter(t => t.id === a.id);
        if (transaksiAnggota.length > 0) {
          const latestDate = transaksiAnggota.reduce((latest, t) => {
            return new Date(t.tgl) > new Date(latest) ? t.tgl : latest;
          }, a.tgl);
          a.lastInterestDate = latestDate;
        }
      });

      triggerSave();
      await showCustomModal(
        'Import Berhasil', 
        `Data berhasil diimport!<br><br>` +
        `Anggota: ${anggotaList.length} orang<br>` +
        `Transaksi: ${transaksiList.length} record`
      );
      
      document.getElementById('importExcel').value = '';
    } catch (err) {
      await showCustomModal('Import Gagal', 'Format file tidak sesuai!<br>Pastikan menggunakan template yang benar.');
      console.error(err);
    }
  };
  reader.readAsArrayBuffer(file);
}

function downloadTemplateExcel() {
  const wb = XLSX.utils.book_new();
  
  // Sheet 1: Template Anggota
  const wsAnggota = XLSX.utils.aoa_to_sheet([
    ['üìã TEMPLATE DATA ANGGOTA', '', '', '', '', ''],
    ['‚ö†Ô∏è PASTIKAN: Setiap anggota memiliki transaksi "Pendaftaran Awal" di sheet Transaksi', '', '', '', '', ''],
    ['', '', '', '', '', ''],
    ['Tanggal', 'ID', 'Nama', 'Simpanan Pokok', 'Simpanan Wajib', 'Simpanan Sukarela'],
    ['2024-01-01', 'A001', 'Budi Santoso', 100000, 50000, 0],
    ['2024-01-01', 'A002', 'Siti Rahayu', 100000, 50000, 100000]
  ]);
  XLSX.utils.book_append_sheet(wb, wsAnggota, '1. Data Anggota');
  
  // Sheet 2: Template Transaksi
  const wsTransaksi = XLSX.utils.aoa_to_sheet([
    ['üìã TRANSAKSI (WAJIB ADA)', '', '', '', '', '', '', '', ''],
    ['‚ö†Ô∏è SETIAP ANGGOTA HARUS PUNYA 1 BARIS "Pendaftaran Awal"', '', '', '', '', '', '', '', ''],
    ['', '', '', '', '', '', '', '', ''],
    ['Tanggal', 'ID', 'Nama', 'Tambah Wajib', 'Tambah Sukarela', 'Bunga Sukarela', 'Sukarela Setelah', 'Tambah Belanja', 'Keterangan'],
    ['2024-01-01', 'A001', 'Budi Santoso', 50000, 0, 0, 0, 0, 'Pendaftaran Awal'],
    ['2024-02-01', 'A001', 'Budi Santoso', 50000, 100000, 0, 100000, 50000, 'Transaksi Rutin'],
    ['2024-01-01', 'A002', 'Siti Rahayu', 50000, 100000, 0, 100000, 0, 'Pendaftaran Awal']
  ]);
  XLSX.utils.book_append_sheet(wb, wsTransaksi, '2. Transaksi (WAJIB)');
  
  XLSX.writeFile(wb, 'TEMPLATE_KMP_Pasirgombong.xlsx');
}

// ===== ANGGOTA =====
async function tambahAnggota() {
  const tgl = document.getElementById('daftarTanggal').value;
  let id = document.getElementById('daftarId').value.trim();
  const nama = document.getElementById('daftarNama').value.trim();
  const pokok = getCurrencyValue('daftarPokok');
  const wajib = getCurrencyValue('daftarWajib');
  const sukarela = getCurrencyValue('daftarSukarela');

  if (!tgl || !nama || pokok<=0 || wajib<=0) {
    await showCustomModal('Peringatan', 'Data tidak lengkap!<br>Pokok & Wajib minimal Rp 1.');
    return;
  }
  
  if (!id) id = 'A' + String(anggotaList.length+1).padStart(3,'0');
  if (anggotaList.some(a=>a.id===id)) {
    await showCustomModal('Peringatan', 'ID sudah ada!<br>Gunakan ID yang unik.');
    return;
  }

  const anggota = { 
    tgl, id, nama, pokok, wajib, sukarela,
    totalDana: bulatkan(pokok + wajib + sukarela), 
    lastInterestDate: tgl, 
    shu: 0 
  };
  
  const confirmed = await showCustomModal(
    'Tambah Anggota',
    `<strong>${nama}</strong> (${id})<br><br>` +
    `Tanggal: ${tgl}<br>` +
    `Simpanan Pokok: ${formatRupiah(pokok)}<br>` +
    `Simpanan Wajib: ${formatRupiah(wajib)}<br>` +
    `Simpanan Sukarela: ${formatRupiah(sukarela)}<br><br>` +
    'Tambahkan anggota baru?'
  );
  
  if (confirmed) {
    anggotaList.push(anggota);
    transaksiList.push({
      tgl, id, nama, 
      tambahWajib: bulatkan(wajib), 
      tambahSukarela: bulatkan(sukarela),
      bunga: 0, 
      sukarelaSetelah: bulatkan(sukarela), 
      belanja: 0, 
      keterangan: 'Pendaftaran Awal'
    });

    triggerSave();
    document.getElementById('daftarId').value = '';
    document.getElementById('daftarNama').value = '';
    document.getElementById('daftarPokok').value = '100.000';
    document.getElementById('daftarWajib').value = '50.000';
    document.getElementById('daftarSukarela').value = '0';
    setupCurrencyInputs();
    await showCustomModal('Sukses', 'Anggota berhasil ditambahkan!');
  }
}

function renderTableAnggota() {
  const tbody = document.querySelector('#tableAnggota tbody');
  tbody.innerHTML = '';
  anggotaList.forEach((a,i) => {
    tbody.innerHTML += `<tr>
      <td onclick="editCell(${i},'tgl',this)" class="editable">${a.tgl}</td>
      <td>${a.id}</td>
      <td onclick="editCell(${i},'nama',this)" class="editable">${a.nama}</td>
      <td onclick="editCell(${i},'pokok',this)" class="editable">${formatRupiah(a.pokok)}</td>
      <td onclick="editCell(${i},'wajib',this)" class="editable">${formatRupiah(a.wajib)}</td>
      <td onclick="editCell(${i},'sukarela',this)" class="editable">${formatRupiah(a.sukarela)}</td>
      <td onclick="editCell(${i},'shu',this)" class="editable">${formatRupiah(a.shu)}</td>
      <td><strong>${formatRupiah(bulatkan(a.totalDana + a.shu))}</strong></td>
      <td>
        <button class="btn-success" onclick="saveEdit(${i})">Simpan</button>
        <button class="btn-danger" onclick="hapusAnggota(${i})">Hapus</button>
      </td>
    </tr>`;
  });
}

function editCell(i, field, cell) {
  const a = anggotaList[i];
  let value = a[field];
  let type = 'text';
  
  if (field === 'tgl') {
    type = 'date';
  } else if (['pokok', 'wajib', 'sukarela', 'shu'].includes(field)) {
    type = 'text';
    value = value.toString();
  } else {
    type = 'text';
  }
  
  cell.innerHTML = `<input type="${type}" value="${value}" id="edit-${field}-${i}" class="${type === 'text' && ['pokok','wajib','sukarela','shu'].includes(field) ? 'currency-input' : ''}">`;
  
  if (type === 'text' && ['pokok','wajib','sukarela','shu'].includes(field)) {
    setTimeout(() => setupCurrencyInputs(), 10);
  }
}

async function saveEdit(i) {
  const a = anggotaList[i];
  const tgl = document.getElementById(`edit-tgl-${i}`)?.value || a.tgl;
  const nama = document.getElementById(`edit-nama-${i}`)?.value?.trim() || a.nama;
  const pokok = getCurrencyValue(`edit-pokok-${i}`);
  const wajib = getCurrencyValue(`edit-wajib-${i}`);
  const sukarela = getCurrencyValue(`edit-sukarela-${i}`);
  const shu = getCurrencyValue(`edit-shu-${i}`);

  if (!nama || pokok<=0 || wajib<=0) {
    await showCustomModal('Peringatan', 'Data tidak valid!<br>Pokok & Wajib minimal Rp 1.');
    return;
  }
  
  const confirmed = await showCustomModal(
    'Simpan Perubahan',
    `Simpan perubahan untuk <strong>${nama}</strong>?<br><br>` +
    `Pokok: ${formatRupiah(pokok)}<br>` +
    `Wajib: ${formatRupiah(wajib)}<br>` +
    `Sukarela: ${formatRupiah(sukarela)}`
  );
  
  if (confirmed) {
    a.tgl = tgl; 
    a.nama = nama; 
    a.pokok = bulatkan(pokok); 
    a.wajib = bulatkan(wajib); 
    a.sukarela = bulatkan(sukarela); 
    a.shu = bulatkan(shu);
    a.totalDana = bulatkan(pokok + wajib + sukarela); 
    a.lastInterestDate = tgl;

    const init = transaksiList.find(t=>t.id===a.id && t.keterangan==='Pendaftaran Awal');
    if (init) { 
      init.tgl=tgl; 
      init.nama=nama; 
      init.tambahWajib=bulatkan(wajib); 
      init.tambahSukarela=bulatkan(sukarela); 
      init.sukarelaSetelah=bulatkan(sukarela); 
    }

    triggerSave();
    await showCustomModal('Sukses', 'Data berhasil diperbarui!');
  }
}

async function hapusAnggota(i) {
  const nama = anggotaList[i].nama;
  const id = anggotaList[i].id;
  
  const confirmed = await showCustomModal(
    'Hapus Anggota',
    `Hapus anggota <strong>${nama} (${id})</strong>?<br><br>` +
    'Semua transaksi anggota ini juga akan dihapus!'
  );
  
  if (confirmed) {
    anggotaList.splice(i,1);
    transaksiList = transaksiList.filter(t=>t.id!==id);
    triggerSave();
    await showCustomModal('Sukses', 'Anggota berhasil dihapus!');
  }
}

function updateSelectAnggota() {
  const sel = document.getElementById('selAnggota');
  sel.innerHTML = '<option value="">-- Pilih Anggota --</option>';
  anggotaList.forEach((a,i)=> sel.innerHTML += `<option value="${i}">${a.id} - ${a.nama}</option>`);
}

// ===== TRANSAKSI =====
function updatePreviewAnggota() {
  const i = document.getElementById('selAnggota').value;
  const prev = document.getElementById('previewArea');
  if (i==='') { 
    prev.innerHTML='Pilih anggota...'; 
    resetTransactionInputs();
    return; 
  }
  const a = anggotaList[i];
  prev.innerHTML = `<strong>${a.nama} (${a.id})</strong><br>
    Pokok: ${formatRupiah(a.pokok)}<br>Wajib: ${formatRupiah(a.wajib)}<br>
    Sukarela: ${formatRupiah(a.sukarela)}<br>SHU: ${formatRupiah(a.shu)}<br>
    <strong>Total: ${formatRupiah(bulatkan(a.totalDana + a.shu))}</strong>`;
}

function prosesTransaksi() {
  const i = document.getElementById('selAnggota').value;
  const tgl = document.getElementById('trxTanggal').value;
  const w = getCurrencyValue('inputTambahWajib');
  const s = getCurrencyValue('inputTambahSukarela');
  const b = getCurrencyValue('inputBelanja');

  const a = anggotaList[i];
  let bunga = 0;
  if (a.sukarela>0) { 
    bunga = bulatkan(a.sukarela * (BUNGA_SUKARELA/100)); 
    a.sukarela = bulatkan(a.sukarela + bunga); 
  }
  a.wajib = bulatkan(a.wajib + w); 
  a.sukarela = bulatkan(a.sukarela + s); 
  a.totalDana = bulatkan(a.pokok + a.wajib + a.sukarela); 
  a.lastInterestDate = tgl;

  transaksiList.push({
    tgl, 
    id:a.id, 
    nama:a.nama, 
    tambahWajib:bulatkan(w), 
    tambahSukarela:bulatkan(s),
    bunga:bulatkan(bunga), 
    sukarelaSetelah:bulatkan(a.sukarela), 
    belanja:bulatkan(b), 
    keterangan:'Transaksi'
  });

  triggerSave();
  updatePreviewAnggota();
  resetTransactionInputs();
}

function updateAllMembers() {
  const prev = document.getElementById('previewArea');
  if (!anggotaList.length) { 
    prev.innerHTML='Belum ada anggota'; 
    return; 
  }
  let html = '<h4>Semua Anggota</h4>';
  anggotaList.forEach(a=> {
    html += `<div style="margin-bottom:15px"><strong>${a.nama} (${a.id})</strong><br>
      Pokok: ${formatRupiah(a.pokok)}<br>Wajib: ${formatRupiah(a.wajib)}<br>
      Sukarela: ${formatRupiah(a.sukarela)}<br>SHU: ${formatRupiah(a.shu)}<br>
      <strong>Total: ${formatRupiah(bulatkan(a.totalDana + a.shu))}</strong></div>`;
  });
  prev.innerHTML = html;
}

function applyInterestOneMonth() {
  const tgl = document.getElementById('trxTanggal').value;
  if (!tgl || !anggotaList.length) return;
  
  let cnt=0;
  anggotaList.forEach(a=> {
    if (a.sukarela>0) {
      const bunga = bulatkan(a.sukarela * (BUNGA_SUKARELA/100));
      a.sukarela = bulatkan(a.sukarela + bunga); 
      a.totalDana = bulatkan(a.pokok + a.wajib + a.sukarela); 
      a.lastInterestDate = tgl;
      
      transaksiList.push({
        tgl, id:a.id, nama:a.nama, 
        tambahWajib:0, tambahSukarela:0,
        bunga:bulatkan(bunga), 
        sukarelaSetelah:bulatkan(a.sukarela), 
        belanja:0, 
        keterangan:'Bunga Bulanan'
      });
      cnt++;
    }
  });
  triggerSave();
}

function applyInterestCustomMonths() {
  const tgl = document.getElementById('trxTanggal').value;
  const m = +document.getElementById('customBulan').value || 1;
  if (!tgl || !anggotaList.length || m<1) return;
  
  const base = new Date(tgl);
  let cnt=0;
  anggotaList.forEach(a=> {
    let cur = a.sukarela;
    for(let i=0;i<m;i++){
      const d = new Date(base); 
      d.setMonth(base.getMonth()-i);
      const ds = d.toISOString().slice(0,10);
      if(cur>0){
        const b = bulatkan(cur * (BUNGA_SUKARELA/100));
        cur = bulatkan(cur + b);
        transaksiList.push({
          tgl:ds, id:a.id, nama:a.nama, 
          tambahWajib:0, tambahSukarela:0,
          bunga:bulatkan(b), 
          sukarelaSetelah:bulatkan(cur), 
          belanja:0,
          keterangan:`Bunga ${d.toLocaleString('id-ID',{month:'long',year:'numeric'})}`
        });
      }
    }
    if(cur>a.sukarela){ 
      a.sukarela=bulatkan(cur); 
      a.totalDana=bulatkan(a.pokok+a.wajib+a.sukarela); 
      a.lastInterestDate=tgl; 
      cnt++; 
    }
  });
  triggerSave();
}

function renderTableTransaksi() {
  const tbody = document.querySelector('#tableTransaksi tbody');
  tbody.innerHTML = '';
  [...transaksiList].reverse().forEach(t=> {
    tbody.innerHTML += `<tr>
      <td>${t.tgl}</td><td>${t.id}</td><td>${t.nama}</td>
      <td>${formatRupiah(t.tambahWajib)}</td><td>${formatRupiah(t.tambahSukarela)}</td>
      <td>${formatRupiah(t.bunga)}</td><td>${formatRupiah(t.sukarelaSetelah)}</td>
      <td>${formatRupiah(t.belanja)}</td>
    </tr>`;
  });
}

function renderTableInfoAnggota() {
  const tbody = document.querySelector('#tableInfoAnggota tbody');
  tbody.innerHTML = '';
  anggotaList.forEach((a,i)=> {
    tbody.innerHTML += `<tr>
      <td>${a.lastInterestDate || a.tgl}</td>
      <td>${a.id}</td><td>${a.nama}</td>
      <td><input type="text" id="info-tambahWajib-${i}" 
           value="0" class="currency-input" placeholder="0"></td>
      <td><input type="text" id="info-tambahSukarela-${i}" 
           value="0" class="currency-input" placeholder="0"></td>
      <td>-</td><td>${formatRupiah(a.sukarela)}</td>
      <td><input type="text" id="info-belanja-${i}" 
           value="0" class="currency-input" placeholder="0"></td>
      <td>
        <button class="btn-success" onclick="saveInfoAnggota(${i})">Simpan</button>
        <button class="btn-danger" onclick="deleteInfoAnggota(${i})">Hapus</button>
      </td>
    </tr>`;
  });
  setupCurrencyInputs();
}

async function saveInfoAnggota(i) {
  const a = anggotaList[i];
  const tgl = document.getElementById('trxTanggal').value;
  const w = getCurrencyValue(`info-tambahWajib-${i}`);
  const s = getCurrencyValue(`info-tambahSukarela-${i}`);
  const b = getCurrencyValue(`info-belanja-${i}`);
  
  if (!tgl || (w===0 && s===0 && b===0)) {
    await showCustomModal('Peringatan', 'Isi minimal satu transaksi!');
    return;
  }
  
  const confirmed = await showCustomModal(
    'Simpan Transaksi',
    `<strong>${a.nama} (${a.id})</strong><br><br>` +
    `Tanggal: ${tgl}<br>` +
    `Tambah Wajib: ${formatRupiah(w)}<br>` +
    `Tambah Sukarela: ${formatRupiah(s)}<br>` +
    `Tambah Belanja: ${formatRupiah(b)}<br><br>` +
    'Simpan transaksi ini?'
  );
  
  if (confirmed) {
    a.wajib = bulatkan(a.wajib + w); 
    a.sukarela = bulatkan(a.sukarela + s); 
    a.totalDana = bulatkan(a.pokok + a.wajib + a.sukarela); 
    a.lastInterestDate = tgl;
    
    transaksiList.push({
      tgl, id:a.id, nama:a.nama, 
      tambahWajib:bulatkan(w), 
      tambahSukarela:bulatkan(s),
      bunga:0, 
      sukarelaSetelah:bulatkan(a.sukarela), 
      belanja:bulatkan(b), 
      keterangan:'Info Anggota'
    });

    triggerSave();
    
    // Reset input setelah simpan
    document.getElementById(`info-tambahWajib-${i}`).value = '0';
    document.getElementById(`info-tambahSukarela-${i}`).value = '0';
    document.getElementById(`info-belanja-${i}`).value = '0';
    setupCurrencyInputs();
    
    await showCustomModal('Sukses', 'Transaksi berhasil disimpan!');
  }
}

async function deleteInfoAnggota(i) {
  const a = anggotaList[i];
  
  const confirmed = await showCustomModal(
    'Hapus Transaksi',
    `Hapus transaksi terakhir untuk <strong>${a.nama}</strong>?<br><br>` +
    'Transaksi terakhir akan dihapus dan saldo akan dikurangi.'
  );
  
  if (confirmed) {
    const rev = [...transaksiList].reverse();
    const idx = rev.findIndex(t=>t.id===a.id);
    if (idx===-1) { 
      await showCustomModal('Peringatan', 'Tidak ada transaksi!'); 
      return; 
    }
    
    const realIdx = transaksiList.length - 1 - idx;
    const t = transaksiList[realIdx];
    
    a.wajib = bulatkan(a.wajib - t.tambahWajib);
    a.sukarela = bulatkan(a.sukarela - (t.tambahSukarela + t.bunga));
    a.totalDana = bulatkan(a.pokok + a.wajib + a.sukarela);
    transaksiList.splice(realIdx,1);
    
    triggerSave();
    await showCustomModal('Sukses', 'Transaksi berhasil dihapus!');
  }
}

// ===== SHU =====
function hitungSHU() {
  if (!anggotaList.length) return;
  const totalSHU = getCurrencyValue('shuProfit');
  if (totalSHU<=0) return;

  const p = {
    modal: +document.getElementById('persModal').value || 0,
    belanja: +document.getElementById('persBelanja').value || 0,
    cadangan: +document.getElementById('persCadangan').value || 0,
    pengurus: +document.getElementById('persPengurus').value || 0,
    pengawas: +document.getElementById('persPengawas').value || 0,
    karyawan: +document.getElementById('persKaryawan').value || 0,
    sosial: +document.getElementById('persSosial').value || 0,
    pendidikan: +document.getElementById('persPendidikan').value || 0,
    danaBangun: +document.getElementById('persDanaBangun').value || 0
  };
  
  const sumP = Object.values(p).reduce((a,b)=>a+b,0);
  document.getElementById('totalPersen').innerHTML = `Total: ${sumP.toFixed(1)}% ${sumP===100?'':'(Harus 100%)'}`;
  if (Math.abs(sumP-100)>0.1) return;

  // Hitung nominal per pos (bulatkan)
  const shuModal = bulatkan(totalSHU * (p.modal/100));
  const shuBelanja = bulatkan(totalSHU * (p.belanja/100));
  const shuCadangan = bulatkan(totalSHU * (p.cadangan/100));
  const shuPengurus = bulatkan(totalSHU * (p.pengurus/100));
  const shuPengawas = bulatkan(totalSHU * (p.pengawas/100));
  const shuKaryawan = bulatkan(totalSHU * (p.karyawan/100));
  const shuSosial = bulatkan(totalSHU * (p.sosial/100));
  const shuPendidikan = bulatkan(totalSHU * (p.pendidikan/100));
  const shuDanaBangun = bulatkan(totalSHU * (p.danaBangun/100));

  // Hitung SHU per anggota
  const totalModal = anggotaList.reduce((s,a)=>s+a.pokok+a.wajib,0);
  const totalBelanja = transaksiList.reduce((s,t)=>s+t.belanja,0);
  const belanjaById = {}; 
  transaksiList.forEach(t=> { belanjaById[t.id]=(belanjaById[t.id]||0)+t.belanja; });

  const tbodySHU = document.querySelector('#tableSHU tbody'); 
  tbodySHU.innerHTML='';
  
  let totalSHUAnggota = 0;
  let totalSHUModal = 0;
  let totalSHUBelanja = 0;
  
  anggotaList.forEach(a=> {
    const modal = a.pokok + a.wajib;
    const shuM = totalModal>0 ? bulatkan((modal/totalModal)*shuModal) : 0;
    const belanja = belanjaById[a.id]||0;
    const shuB = (totalBelanja>0 && belanja>0) ? bulatkan((belanja/totalBelanja)*shuBelanja) : 0;
    const total = bulatkan(shuM + shuB);
    a.shu = total; 
    a.totalDana = bulatkan(a.pokok + a.wajib + a.sukarela);

    totalSHUAnggota += total;
    totalSHUModal += shuM;
    totalSHUBelanja += shuB;

    tbodySHU.innerHTML += `<tr>
      <td>${a.id}</td><td>${a.nama}</td>
      <td>${formatRupiah(modal)}</td><td>${formatRupiah(belanja)}</td>
      <td>${formatRupiah(shuM)}</td><td>${formatRupiah(shuB)}</td>
      <td><strong>${formatRupiah(total)}</strong></td>
    </tr>`;
  });

  // Tambah summary row dengan jeda 2 kolom
  tbodySHU.innerHTML += `<tr style="background:#f5f5f5;">
    <td colspan="4" style="text-align:right; border:none;"></td>
    <td style="border:none;"><strong>${formatRupiah(totalSHUModal)}</strong></td>
    <td style="border:none;"><strong>${formatRupiah(totalSHUBelanja)}</strong></td>
    <td style="border:none;"><strong>${formatRupiah(totalSHUAnggota)}</strong></td>
  </tr>`;

  // Tampilkan semua pos SHU
  const tbodyPos = document.querySelector('#tableSHUPos tbody'); 
  tbodyPos.innerHTML='';
  
  const posList = [
    {nama: 'Modal/Simpanan', nilai: shuModal, persen: p.modal},
    {nama: 'Poin Belanja', nilai: shuBelanja, persen: p.belanja},
    {nama: 'Cadangan', nilai: shuCadangan, persen: p.cadangan},
    {nama: 'Pengurus', nilai: shuPengurus, persen: p.pengurus},
    {nama: 'Pengawas', nilai: shuPengawas, persen: p.pengawas},
    {nama: 'Karyawan', nilai: shuKaryawan, persen: p.karyawan},
    {nama: 'Sosial', nilai: shuSosial, persen: p.sosial},
    {nama: 'Pendidikan', nilai: shuPendidikan, persen: p.pendidikan},
    {nama: 'Dana Pembangunan', nilai: shuDanaBangun, persen: p.danaBangun}
  ];
  
  posList.forEach(pos => {
    tbodyPos.innerHTML += `<tr>
      <td>${pos.nama}</td>
      <td>${pos.persen}%</td>
      <td>${formatRupiah(pos.nilai)}</td>
    </tr>`;
  });

  triggerSave();
}

// ===== EXPORT EXCEL =====
function exportToExcel() {
  if (!anggotaList.length) return;
  
  const wb = XLSX.utils.book_new();
  const today = new Date().toISOString().slice(0,10);
  
  // Sheet 2: Data Anggota
  const wsA = XLSX.utils.json_to_sheet(anggotaList.map(a => ({
    'Tanggal': a.tgl,
    'ID': a.id,
    'Nama': a.nama,
    'Simpanan Pokok': a.pokok,      // 100000 (NUMBER)
    'Simpanan Wajib': a.wajib,      // 50000 (NUMBER)
    'Simpanan Sukarela': a.sukarela, // 0 (NUMBER)
    'SHU': a.shu,                   // 0 (NUMBER)
    'Total Dana': bulatkan(a.totalDana + a.shu)  // NUMBER
  })));
  
  // Set column widths
  wsA['!cols'] = [
    {wch: 12}, // Tanggal
    {wch: 10}, // ID
    {wch: 25}, // Nama
    {wch: 15}, // Pokok
    {wch: 15}, // Wajib
    {wch: 15}, // Sukarela
    {wch: 15}, // SHU
    {wch: 15}  // Total Dana
  ];
  
  // Sheet 3: Riwayat Transaksi
  const wsT = XLSX.utils.json_to_sheet([...transaksiList].reverse().map(t => ({
    'Tanggal': t.tgl,
    'ID': t.id,
    'Nama': t.nama,
    'Tambah Wajib': t.tambahWajib,
    'Tambah Sukarela': t.tambahSukarela,
    'Bunga Sukarela': t.bunga,
    'Sukarela Setelah': t.sukarelaSetelah,
    'Tambah Belanja': t.belanja,
    'Keterangan': t.keterangan
  })));
  
  wsT['!cols'] = [
    {wch: 12}, {wch: 10}, {wch: 25}, 
    {wch: 15}, {wch: 15}, {wch: 15}, 
    {wch: 15}, {wch: 15}, {wch: 25}
  ];
  
  // Tambahkan semua sheet
  XLSX.utils.book_append_sheet(wb, wsA, 'Data Anggota');
  XLSX.utils.book_append_sheet(wb, wsT, 'Riwayat Transaksi');
  
  XLSX.writeFile(wb, `Laporan_KMP_Pasirgombong_${today}.xlsx`);
}

function exportSHUToExcel() {
  if (!anggotaList.length) return;
  
  const wb = XLSX.utils.book_new();
  const per = document.getElementById('shuPeriode').value;
  const bln = document.getElementById('shuBulan').value;
  
  // Format periode string
  let periodeStr = '';
  if (per === 'bulanan') {
    const bulan = new Date(bln);
    periodeStr = `Bulanan ${bulan.toLocaleString('id-ID', {month: 'long', year: 'numeric'})}`;
  } else {
    periodeStr = `Tahunan ${bln}`;
  }

  // Sheet 2: SHU Per Anggota
  const totalSHU = getCurrencyValue('shuProfit');
  const p = {
    modal: +document.getElementById('persModal').value || 0,
    belanja: +document.getElementById('persBelanja').value || 0,
  };
  
  const shuModal = bulatkan(totalSHU * (p.modal / 100));
  const shuBelanja = bulatkan(totalSHU * (p.belanja / 100));
  const totalModal = anggotaList.reduce((s, a) => s + a.pokok + a.wajib, 0);
  const totalBelanja = transaksiList.reduce((s, t) => s + t.belanja, 0);
  const belanjaById = {};
  transaksiList.forEach(t => {
    belanjaById[t.id] = (belanjaById[t.id] || 0) + t.belanja;
  });
  
  const shuData = [];
  shuData.push(['SHU PERIODE:', periodeStr]);
  shuData.push([]);
  shuData.push(['ID', 'Nama', 'Total Modal (Pokok+Wajib)', 'Total Belanja', 'SHU dari Modal', 'SHU dari Belanja', 'Total SHU Diterima']);
  
  let totalSHUAnggota = 0;
  let totalSHUModal = 0;
  let totalSHUBelanja = 0;
  
  anggotaList.forEach(a => {
    const modal = a.pokok + a.wajib;
    const shuM = totalModal > 0 ? bulatkan((modal / totalModal) * shuModal) : 0;
    const belanja = belanjaById[a.id] || 0;
    const shuB = (totalBelanja > 0 && belanja > 0) ? bulatkan((belanja / totalBelanja) * shuBelanja) : 0;
    const total = bulatkan(shuM + shuB);
    
    totalSHUModal += shuM;
    totalSHUBelanja += shuB;
    totalSHUAnggota += total;
    
    shuData.push([
      a.id,
      a.nama,
      modal,
      belanja,
      shuM,
      shuB,
      total
    ]);
  });
  
  // Summary
  shuData.push([]);
  shuData.push(['TOTAL SHU MODAL', '', '', '', '', '', totalSHUModal]);
  shuData.push(['TOTAL SHU BELANJA', '', '', '', '', '', totalSHUBelanja]);
  shuData.push(['GRAND TOTAL SHU ANGGOTA', '', '', '', '', '', totalSHUAnggota]);
  
  const wsSHU = XLSX.utils.aoa_to_sheet(shuData);
  wsSHU['!cols'] = [
    {wch: 10}, {wch: 25}, {wch: 20}, {wch: 20}, 
    {wch: 15}, {wch: 20}, {wch: 20}
  ];
  
  // Sheet 3: Alokasi SHU
  const posData = [];
  posData.push(['SHU PERIODE:', periodeStr]);
  posData.push([]);
  posData.push(['Pos SHU', 'Persentase', 'Nominal (Rp)']);
  
  const posList = [
    {nama: 'Modal/Simpanan', persen: p.modal, nilai: shuModal},
    {nama: 'Poin Belanja', persen: p.belanja, nilai: shuBelanja},
    {nama: 'Cadangan', persen: +document.getElementById('persCadangan').value, nilai: bulatkan(totalSHU * (+document.getElementById('persCadangan').value/100))},
    {nama: 'Pengurus', persen: +document.getElementById('persPengurus').value, nilai: bulatkan(totalSHU * (+document.getElementById('persPengurus').value/100))},
    {nama: 'Pengawas', persen: +document.getElementById('persPengawas').value, nilai: bulatkan(totalSHU * (+document.getElementById('persPengawas').value/100))},
    {nama: 'Karyawan', persen: +document.getElementById('persKaryawan').value, nilai: bulatkan(totalSHU * (+document.getElementById('persKaryawan').value/100))},
    {nama: 'Sosial', persen: +document.getElementById('persSosial').value, nilai: bulatkan(totalSHU * (+document.getElementById('persSosial').value/100))},
    {nama: 'Pendidikan', persen: +document.getElementById('persPendidikan').value, nilai: bulatkan(totalSHU * (+document.getElementById('persPendidikan').value/100))},
    {nama: 'Dana Pembangunan', persen: +document.getElementById('persDanaBangun').value, nilai: bulatkan(totalSHU * (+document.getElementById('persDanaBangun').value/100))}
  ];
  
  posList.forEach(pos => {
    posData.push([pos.nama, `${pos.persen}%`, pos.nilai]);
  });
  
  posData.push([]);
  posData.push(['TOTAL', '100%', totalSHU]);
  
  const wsPos = XLSX.utils.aoa_to_sheet(posData);
  wsPos['!cols'] = [{wch: 25}, {wch: 15}, {wch: 20}];
  
  // Tambahkan semua sheet
  XLSX.utils.book_append_sheet(wb, wsInstruksi, 'PETUNJUK');
  XLSX.utils.book_append_sheet(wb, wsSHU, 'SHU Per Anggota');
  XLSX.utils.book_append_sheet(wb, wsPos, 'Alokasi SHU');
  
  // Save file
  const fileName = per === 'bulanan' ?
    `Laporan_SHU_Bulan_${new Date(bln).toLocaleString('id-ID', {month: 'long', year: 'numeric'}).replace(' ', '_')}.xlsx` :
    `Laporan_SHU_Tahun_${bln}.xlsx`;
  
  XLSX.writeFile(wb, fileName);
}

// ===== SAVE ALL FUNCTIONS =====
async function saveAllAnggota() {
  let changed = false;
  
  anggotaList.forEach((a, i) => {
    const inputs = [
      document.getElementById(`edit-tgl-${i}`),
      document.getElementById(`edit-nama-${i}`),
      document.getElementById(`edit-pokok-${i}`),
      document.getElementById(`edit-wajib-${i}`),
      document.getElementById(`edit-sukarela-${i}`),
      document.getElementById(`edit-shu-${i}`)
    ];
    
    if (inputs.some(inp => inp)) {
      const tgl = inputs[0]?.value || a.tgl;
      const nama = inputs[1]?.value?.trim() || a.nama;
      const pokok = getCurrencyValue(`edit-pokok-${i}`);
      const wajib = getCurrencyValue(`edit-wajib-${i}`);
      const sukarela = getCurrencyValue(`edit-sukarela-${i}`);
      const shu = getCurrencyValue(`edit-shu-${i}`);

      if (nama && pokok > 0 && wajib > 0) {
        a.tgl = tgl;
        a.nama = nama;
        a.pokok = bulatkan(pokok);
        a.wajib = bulatkan(wajib);
        a.sukarela = bulatkan(sukarela);
        a.shu = bulatkan(shu);
        a.totalDana = bulatkan(pokok + wajib + sukarela);
        a.lastInterestDate = tgl;
        changed = true;
      }
    }
  });

  if (changed) {
    triggerSave();
    await showCustomModal('Sukses', 'Semua perubahan di tabel Data Anggota telah disimpan!');
  } else {
    await showCustomModal('Info', 'Tidak ada perubahan yang terdeteksi.');
  }
}

async function saveAllInfoAnggota() {
  const tgl = document.getElementById('trxTanggal').value;
  if (!tgl) {
    await showCustomModal('Peringatan', 'Isi Tanggal Transaksi terlebih dahulu!');
    return;
  }

  let savedCount = 0;
  anggotaList.forEach((a, i) => {
    const w = getCurrencyValue(`info-tambahWajib-${i}`);
    const s = getCurrencyValue(`info-tambahSukarela-${i}`);
    const b = getCurrencyValue(`info-belanja-${i}`);

    if (w > 0 || s > 0 || b > 0) {
      a.wajib = bulatkan(a.wajib + w);
      a.sukarela = bulatkan(a.sukarela + s);
      a.totalDana = bulatkan(a.pokok + a.wajib + a.sukarela);
      a.lastInterestDate = tgl;

      transaksiList.push({
        tgl,
        id: a.id,
        nama: a.nama,
        tambahWajib: bulatkan(w),
        tambahSukarela: bulatkan(s),
        bunga: 0,
        sukarelaSetelah: bulatkan(a.sukarela),
        belanja: bulatkan(b),
        keterangan: 'Info Anggota (Batch)'
      });
      savedCount++;
      
      // Reset input
      document.getElementById(`info-tambahWajib-${i}`).value = '0';
      document.getElementById(`info-tambahSukarela-${i}`).value = '0';
      document.getElementById(`info-belanja-${i}`).value = '0';
    }
  });

  if (savedCount > 0) {
    triggerSave();
    setupCurrencyInputs();
    await showCustomModal(
      'Sukses',
      `Berhasil menyimpan ${savedCount} transaksi dari Info Anggota!`
    );
  } else {
    await showCustomModal('Info', 'Tidak ada transaksi yang diisi untuk disimpan.');
  }
}

// ===== RESET ALL DATA =====
function resetAllData() {
  anggotaList = [];
  transaksiList = [];
  localStorage.removeItem(STORAGE_KEY);
  
  renderTableAnggota();
  updateSelectAnggota();
  renderTableTransaksi();
  renderTableInfoAnggota();
  
  document.querySelector('#tableSHU tbody').innerHTML = '';
  document.querySelector('#tableSHUPos tbody').innerHTML = '';
  
  resetTransactionInputs();
}

</script>
</body>
</html>
